<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opening Mercle...</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            width: 100%;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        p {
            margin: 10px 0;
            opacity: 0.9;
        }

        .button-group {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        button,
        a.button {
            padding: 15px 30px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            text-decoration: none;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover,
        a.button:hover {
            transform: scale(1.05);
        }

        .small-button {
            font-size: 14px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .debug {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 12px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug pre {
            margin: 5px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .fallback {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .fallback a {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            font-size: 14px;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="loader" id="loader"></div>
        <h1 id="title">Opening Mercle App...</h1>
        <p id="status">Preparing...</p>

        <div class="button-group" id="buttons" style="display: none;"></div>

        <div class="fallback" id="fallback" style="display: none;">
            <a href="https://play.google.com/store/apps/details?id=com.mercle.app">üì• Get on Android</a>
            <a href="https://apps.apple.com/ng/app/mercle/id6751991316">üì• Get on iOS</a>
        </div>

        <div class="debug" id="debug">
            <strong>Debug Log:</strong>
            <div id="debugLog"></div>
        </div>
    </div>

    <script>
        // ================================================================
        // DEBUG LOGGING
        // ================================================================
        const debugLog = [];
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            debugLog.push(logMessage);
            console.log(logMessage);
            document.getElementById('debugLog').innerHTML = debugLog.map(l => `<pre>${l}</pre>`).join('');
        }

        log('üöÄ Page loaded');
        log('üìç URL: ' + window.location.href);

        // ================================================================
        // EXTRACT PARAMETERS
        // ================================================================
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session_id');
        const appName = params.get('app_name') || 'Telegram Verification Bot';
        const appDomain = params.get('app_domain') || 'telegram.mercle.ai';
        const base64Qr = params.get('base64_qr') || '';

        log('üìä Session ID: ' + (sessionId || 'MISSING'));
        log('üìä App Name: ' + appName);
        log('üìä App Domain: ' + appDomain);
        if (base64Qr) log('üìä QR data: present');

        // ================================================================
        // BUILD DEEP LINKS
        // ================================================================
        const deepLinkParams = new URLSearchParams({
            session_id: sessionId,
            app_name: appName,
            app_domain: appDomain
        });

        if (base64Qr) {
            deepLinkParams.set('base64_qr', base64Qr);
        }

        const directLink = `mercle://scan-authenticate?${deepLinkParams.toString()}`;
        const intentUrl = `intent://scan-authenticate?${deepLinkParams.toString()}#Intent;scheme=mercle;package=com.mercle.app;S.browser_fallback_url=https://play.google.com/store/apps/details?id=com.mercle.app;end`;

        log('üîó Direct Link: ' + directLink);
        log('üîó Intent URL: ' + intentUrl);

        // ================================================================
        // DETECT PLATFORM
        // ================================================================
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isMobile = isIOS || isAndroid;

        log('üì± Platform: ' + (isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'));
        log('üì± User Agent: ' + navigator.userAgent);

        // ================================================================
        // ATTEMPT COUNTER
        // ================================================================
        let attemptCount = 0;

        // ================================================================
        // TRY TO OPEN APP
        // ================================================================
        function tryOpenApp(method) {
            attemptCount++;
            log(`üöÄ Attempt #${attemptCount} - Method: ${method}`);

            if (method === 'intent' && isAndroid) {
                log('üì§ Opening Intent URL...');
                window.location.href = intentUrl;
            } else if (method === 'direct') {
                log('üì§ Opening Direct Link...');
                window.location.href = directLink;
            }

            // Check if app opened after 3 seconds
            setTimeout(() => {
                if (!document.hidden) {
                    log('‚ö†Ô∏è App did not open (still on page)');
                    showRetryButtons();
                } else {
                    log('‚úÖ App likely opened (page hidden)');
                }
            }, 3000);
        }

        // ================================================================
        // SHOW RETRY BUTTONS
        // ================================================================
        function showRetryButtons() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('title').textContent = 'Need Help Opening Mercle?';
            document.getElementById('status').innerHTML = '<p>The app didn\'t open automatically. Try the buttons below:</p>';

            const buttonsDiv = document.getElementById('buttons');
            buttonsDiv.style.display = 'block';

            if (isAndroid) {
                buttonsDiv.innerHTML = `
                    <a href="${intentUrl}" class="button" onclick="log('üîÑ Retry: Intent URL'); return true;">
                        üöÄ Open Mercle (Method 1)
                    </a>
                    <a href="${directLink}" class="button" onclick="log('üîÑ Retry: Direct Link'); return true;">
                        üîó Open Mercle (Method 2)
                    </a>
                    <button class="button small-button" onclick="location.reload()">üîÑ Refresh Page</button>
                `;
            } else if (isIOS) {
                buttonsDiv.innerHTML = `
                    <a href="${directLink}" class="button" onclick="log('üîÑ Retry: Direct Link'); return true;">
                        üöÄ Open Mercle App
                    </a>
                    <button class="button small-button" onclick="location.reload()">üîÑ Refresh Page</button>
                `;
            } else {
                buttonsDiv.innerHTML = `
                    <p style="color: rgba(255,255,255,0.7);">Please open this link on your mobile device</p>
                `;
            }

            document.getElementById('fallback').style.display = 'flex';
        }

        // ================================================================
        // VISIBILITY CHANGE DETECTION
        // ================================================================
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                log('üëã Page hidden - app likely opened!');
            } else {
                log('üîô Page visible again - user returned');
            }
        });

        // ================================================================
        // AUTO-START (ISSUE #2 FIXED - TRY BOTH METHODS!)
        // ================================================================
        if (!sessionId) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('title').textContent = 'Invalid Link';
            document.getElementById('status').textContent = 'Missing session_id.';
            document.getElementById('fallback').style.display = 'flex';
        } else if (isMobile) {
            document.getElementById('status').textContent = 'Launching Mercle app...';

            // Try Intent URL first for Android
            if (isAndroid) {
                tryOpenApp('intent');

                // If that fails, try direct link after 5 seconds
                setTimeout(() => {
                    if (!document.hidden && attemptCount === 1) {
                        log('‚ö†Ô∏è Intent URL failed, trying direct link...');
                        tryOpenApp('direct');
                    }
                }, 5000);
            } else if (isIOS) {
                // iOS: Try direct link
                tryOpenApp('direct');
            }
        } else {
            // Desktop - show QR code
            document.getElementById('loader').style.display = 'none';
            document.getElementById('title').textContent = 'Scan with Mercle App';
            
            // Generate QR code for desktop users
            if (base64Qr) {
                // Decode base64 QR and display
                try {
                    const qrData = atob(base64Qr);
                    log('üìä QR data decoded for display');
                    
                    // Create QR code using a simple library or canvas
                    const qrContainer = document.createElement('div');
                    qrContainer.style.cssText = 'background: white; padding: 20px; border-radius: 12px; margin: 20px auto; display: inline-block;';
                    
                    // Use qrcode.js library (add to page)
                    const qrScript = document.createElement('script');
                    qrScript.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js';
                    qrScript.onload = () => {
                        const canvas = document.createElement('canvas');
                        QRCode.toCanvas(canvas, qrData, { width: 256, margin: 2 }, (error) => {
                            if (error) {
                                log('‚ùå QR generation failed: ' + error);
                                qrContainer.innerHTML = '<p style="color: #333;">QR code unavailable</p>';
                            } else {
                                qrContainer.appendChild(canvas);
                            }
                        });
                    };
                    document.head.appendChild(qrScript);
                    
                    document.getElementById('status').innerHTML = '';
                    document.getElementById('status').appendChild(qrContainer);
                    document.getElementById('status').innerHTML += `
                        <p style="margin-top: 16px;">Open the Mercle app on your phone and scan this code</p>
                    `;
                } catch (e) {
                    log('‚ùå Failed to decode QR: ' + e);
                    document.getElementById('status').innerHTML = `
                        <p>Please open this link on your mobile device</p>
                    `;
                }
            } else {
                document.getElementById('status').innerHTML = `
                    <p>Please open this link on your mobile device</p>
                `;
            }
            
            document.getElementById('fallback').style.display = 'flex';
        }

        log('‚úÖ Script loaded successfully');
    </script>
</body>

</html>