<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mercle Bot Settings</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        --bg: var(--tg-theme-bg-color, #0f0f10);
        --text: var(--tg-theme-text-color, #ffffff);
        --hint: var(--tg-theme-hint-color, rgba(255, 255, 255, 0.7));
        --card: var(--tg-theme-secondary-bg-color, #17181a);
        --btn: var(--tg-theme-button-color, #4a7cff);
        --btnText: var(--tg-theme-button-text-color, #ffffff);
        --danger: #ff4d4d;
        --ok: #35c759;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .wrap {
        padding: 16px;
        max-width: 820px;
        margin: 0 auto;
      }

      .title {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 10px;
      }

      .sub {
        margin: 0 0 16px;
        color: var(--hint);
        font-size: 13px;
        line-height: 1.4;
      }

      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 14px;
        margin: 12px 0;
      }

      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .row:last-child {
        border-bottom: 0;
      }

      .label {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .label .k {
        font-weight: 600;
      }
      .label .d {
        font-size: 12px;
        color: var(--hint);
      }

      select,
      input[type="number"] {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        outline: none;
        min-width: 220px;
      }

      textarea {
        width: 100%;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        outline: none;
        resize: vertical;
        min-height: 96px;
        line-height: 1.35;
        font-family: inherit;
        font-size: 14px;
      }

      .toggle {
        width: 44px;
        height: 26px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.16);
        position: relative;
        cursor: pointer;
        flex: 0 0 auto;
      }

      .toggle[data-on="true"] {
        background: var(--btn);
      }

      .toggle::after {
        content: "";
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: white;
        transition: transform 140ms ease;
      }

      .toggle[data-on="true"]::after {
        transform: translateX(18px);
      }

      .pill {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        color: var(--hint);
      }
      .pill.ok {
        color: var(--ok);
      }
      .pill.bad {
        color: var(--danger);
      }

      .actions {
        display: flex;
        gap: 10px;
      }

      .checklist {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 8px;
      }

      .check {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .check input {
        transform: scale(1.2);
      }

      button {
        border: 0;
        border-radius: 12px;
        padding: 12px 14px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn {
        background: var(--btn);
        color: var(--btnText);
        width: 100%;
      }
      .btn.secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
      }

      .error {
        color: var(--danger);
        font-size: 13px;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1 class="title">Bot Settings</h1>
      <p class="sub">
        This Mini App is optional. It only lists groups where you have permission to manage settings. Your Telegram
        <code>initData</code> is verified server-side.
      </p>

      <div id="notg" class="card" style="display:none">
        <div class="error">Open this page from inside Telegram (as a Web App).</div>
      </div>

      <div id="err" class="card" style="display:none">
        <div class="error" id="errText"></div>
      </div>

      <div class="card">
        <div class="row">
          <div class="label">
            <div class="k">Group</div>
            <div class="d">Choose which chat to configure</div>
          </div>
          <select id="groupSelect"></select>
        </div>
      </div>

      <div id="preflight" class="card" style="display:none">
        <div class="row">
          <div class="label">
            <div class="k">Preflight</div>
            <div class="d">Bot permissions and join-gate readiness</div>
          </div>
          <div class="actions">
            <span id="pf_admin" class="pill">Admin</span>
            <span id="pf_restrict" class="pill">Restrict</span>
            <span id="pf_delete" class="pill">Delete</span>
            <span id="pf_joinreq" class="pill">Join requests</span>
            <span id="pf_invite" class="pill">Invite users</span>
          </div>
        </div>
      </div>

      <div id="settings" class="card" style="display:none">
        <div class="row">
          <div class="label">
            <div class="k">Verification</div>
            <div class="d">Verify-to-speak flow for new members</div>
          </div>
          <div id="verification_enabled" class="toggle" data-on="false"></div>
        </div>

        <div class="row">
          <div class="label">
            <div class="k">Timeout (seconds)</div>
            <div class="d">How long a user has to verify</div>
          </div>
          <input id="verification_timeout" type="number" min="30" step="10" />
        </div>

        <div class="row">
          <div class="label">
            <div class="k">Action on timeout</div>
            <div class="d">Kick or keep muted</div>
          </div>
          <select id="action_on_timeout">
            <option value="mute">Keep muted</option>
            <option value="kick">Kick</option>
          </select>
        </div>

        <div class="row">
          <div class="label">
            <div class="k">Join gate</div>
            <div class="d">Verify-to-join (requires join requests + invite users)</div>
          </div>
          <div id="join_gate_enabled" class="toggle" data-on="false"></div>
        </div>

        <div class="row">
          <div class="label">
            <div class="k">Antiflood</div>
            <div class="d">Mute users who spam messages quickly</div>
          </div>
          <div id="antiflood_enabled" class="toggle" data-on="false"></div>
        </div>

        <div class="row">
          <div class="label">
            <div class="k">Antiflood limit</div>
            <div class="d">Messages per minute</div>
          </div>
          <input id="antiflood_limit" type="number" min="1" step="1" />
        </div>

        <div class="row">
          <div class="label">
            <div class="k">Lock links</div>
            <div class="d">Deletes messages that look like URLs</div>
          </div>
          <div id="lock_links" class="toggle" data-on="false"></div>
        </div>

        <div class="row">
          <div class="label">
            <div class="k">Lock media</div>
            <div class="d">Deletes photos/videos/documents, etc.</div>
          </div>
          <div id="lock_media" class="toggle" data-on="false"></div>
        </div>

	        <div class="row">
	          <div class="label">
	            <div class="k">Logs destination</div>
	            <div class="d">Off or “this group” only (advanced setup stays in DM)</div>
	          </div>
	          <select id="logs_mode">
	            <option value="">(no change)</option>
	            <option value="off">Off</option>
	            <option value="group">This group</option>
	          </select>
	        </div>
	
	        <div class="row">
	          <div class="label">
	            <div class="k">Logs status</div>
	            <div class="d" id="logs_current">Off</div>
	          </div>
	          <div class="actions">
	            <button id="logsTestBtn" class="btn secondary" style="width:auto">Send test log</button>
	          </div>
	        </div>
	      </div>

      <div id="onboarding" class="card" style="display:none">
        <div class="row">
          <div class="label">
            <div class="k">Onboarding (DM)</div>
            <div class="d">After a user verifies for this group, send them an onboarding message in DM</div>
          </div>
          <div id="onboarding_enabled" class="toggle" data-on="false"></div>
        </div>
        <div class="row">
          <div class="label">
            <div class="k">Delay (seconds)</div>
            <div class="d">Wait before sending the onboarding message</div>
          </div>
          <input id="onboarding_delay_seconds" type="number" min="0" step="10" />
        </div>
        <div class="row">
          <div class="label">
            <div class="k">Message</div>
            <div class="d">Keep it short and human; Markdown/HTML supported</div>
          </div>
        </div>
        <div class="row">
          <textarea id="onboarding_text" placeholder="Welcome! Here are the rules…"></textarea>
        </div>
	        <div class="row">
	          <div class="label">
	            <div class="k">Parse mode</div>
	            <div class="d">Markdown or HTML formatting</div>
	          </div>
	          <select id="onboarding_parse_mode">
	            <option value="Markdown">Markdown</option>
	            <option value="HTML">HTML</option>
	            <option value="">Plain</option>
	          </select>
	        </div>
	
	        <div style="height:12px"></div>
	        <div class="row">
	          <div class="label">
	            <div class="k">Steps</div>
	            <div class="d">Optional follow-ups in DM (max 10 total steps)</div>
	          </div>
	        </div>
	        <div id="onboarding_steps_list" class="checklist"></div>
	        <div class="actions" style="width:100%">
	          <button id="onboardingAddStepBtn" class="btn secondary" style="flex:1">Add step</button>
	          <button id="onboardingRemoveStepBtn" class="btn secondary" style="flex:1">Remove last</button>
	        </div>
	      </div>

      <div id="buttons" class="card" style="display:none">
        <button id="saveBtn" class="btn">Save</button>
        <div style="height: 10px"></div>
        <button id="reloadBtn" class="btn secondary">Reload</button>
      </div>

      <div id="broadcast" class="card" style="display:none">
        <div class="row">
          <div class="label">
            <div class="k">Announcement</div>
            <div class="d">Send a message to one or more groups you can manage (queued + delivered by the bot)</div>
          </div>
        </div>
	        <div class="row">
	          <textarea id="broadcast_text" placeholder="Write your announcement…"></textarea>
	        </div>
	        <div class="row">
	          <div class="label">
	            <div class="k">Schedule</div>
	            <div class="d">Delay in minutes (0 = send now)</div>
	          </div>
	          <input id="broadcast_delay_minutes" type="number" min="0" max="10080" value="0" />
	        </div>
	        <div class="row">
	          <div class="label">
	            <div class="k">Parse mode</div>
	            <div class="d">Markdown or HTML formatting</div>
	          </div>
          <select id="broadcast_parse_mode">
            <option value="Markdown">Markdown</option>
            <option value="HTML">HTML</option>
            <option value="">Plain</option>
          </select>
        </div>
        <div class="row" style="flex-direction:column; align-items:stretch">
          <div class="label" style="margin-bottom:6px">
            <div class="k">Targets</div>
            <div class="d">Choose where to post this announcement</div>
          </div>
          <div class="actions" style="width:100%">
            <button id="broadcastAllBtn" class="btn secondary" style="flex:1">Select all</button>
            <button id="broadcastNoneBtn" class="btn secondary" style="flex:1">Clear</button>
          </div>
          <div id="broadcast_targets" class="checklist"></div>
	        </div>
	        <button id="broadcastBtn" class="btn">Send to selected</button>
	
	        <div style="height:14px"></div>
	        <div class="row" style="justify-content:space-between; align-items:center">
	          <div class="label" style="margin:0">
	            <div class="k">Recent broadcasts</div>
	            <div class="d">Last announcements that targeted this group</div>
	          </div>
	          <button id="broadcastHistoryBtn" class="btn secondary" style="width:auto">Refresh</button>
	        </div>
	        <div id="broadcast_history" class="checklist"></div>
	      </div>

	      <div id="rules" class="card" style="display:none">
	        <div class="row">
	          <div class="label">
	            <div class="k">Rules (v1)</div>
	            <div class="d">Simple automations: match text → actions (reply/delete/warn/mute/log/sequence/ticket)</div>
	          </div>
	        </div>

        <div class="row">
          <input id="rule_pattern" type="text" placeholder="Match pattern (keyword or regex)" />
        </div>

        <div class="row">
          <div class="label">
            <div class="k">Match</div>
            <div class="d">Contains or regex</div>
          </div>
          <select id="rule_match_type">
            <option value="contains">Contains</option>
            <option value="regex">Regex</option>
          </select>
        </div>

        <div class="row">
          <div class="label">
            <div class="k">Action</div>
            <div class="d">What should the bot do when it matches?</div>
          </div>
	          <select id="rule_action_type">
	            <option value="delete">Delete message</option>
	            <option value="warn">Warn user</option>
	            <option value="mute">Mute user</option>
	            <option value="reply">Reply</option>
	            <option value="log">Log to mod channel</option>
	            <option value="start_sequence">Start DM sequence</option>
	            <option value="create_ticket">Create ticket</option>
	          </select>
	        </div>

        <div id="rule_reply_wrap" class="row" style="display:none">
          <textarea id="rule_reply_text" placeholder="Reply text…"></textarea>
        </div>

	        <div id="rule_mute_wrap" class="row" style="display:none">
	          <div class="label">
	            <div class="k">Mute duration (seconds)</div>
	            <div class="d">30–604800</div>
	          </div>
	          <input id="rule_mute_seconds" type="number" min="30" step="30" value="300" />
	        </div>
	
	        <div id="rule_log_wrap" class="row" style="display:none">
	          <textarea id="rule_log_text" placeholder="Log note (optional)…"></textarea>
	        </div>
	
	        <div id="rule_sequence_wrap" class="row" style="display:none">
	          <div class="label">
	            <div class="k">Sequence key</div>
	            <div class="d">Starts a DM sequence for the user (example: onboarding_verified)</div>
	          </div>
	          <input id="rule_sequence_key" type="text" value="onboarding_verified" />
	        </div>
	
	        <div id="rule_ticket_wrap" class="row" style="display:none">
	          <div class="label">
	            <div class="k">Ticket subject (optional)</div>
	            <div class="d">Creates a staff ticket in the logs destination</div>
	          </div>
	          <input id="rule_ticket_subject" type="text" placeholder="Rule: ..." />
	        </div>

	        <button id="ruleAddBtn" class="btn">Add rule</button>

        <div class="row">
          <div class="label">
            <div class="k">Existing rules</div>
            <div class="d">Rules are evaluated before filters/notes</div>
          </div>
	        </div>
	        <div id="rules_list" class="checklist"></div>
	
	        <div style="height:14px"></div>
	        <div class="row">
	          <div class="label">
	            <div class="k">Test console</div>
	            <div class="d">Paste a sample message to see which rules would fire (dry-run)</div>
	          </div>
	        </div>
	        <div class="row">
	          <textarea id="rules_test_text" placeholder="Type a message to test…"></textarea>
	        </div>
	        <button id="rulesTestBtn" class="btn secondary">Test rules</button>
	        <div id="rules_test_results" class="checklist"></div>
	      </div>

      <div id="tickets" class="card" style="display:none">
        <div class="row">
          <div class="label">
            <div class="k">Tickets (v1)</div>
            <div class="d">Recent open tickets created via /ticket (read-only)</div>
          </div>
          <div class="actions">
            <button id="ticketsRefreshBtn" class="btn secondary" style="width:auto">Refresh</button>
          </div>
        </div>
        <div id="tickets_list" class="checklist"></div>
      </div>
    </div>

    <script>
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      const initData = tg ? tg.initData : "";

      const $ = (id) => document.getElementById(id);

      function setError(msg) {
        $("errText").textContent = msg;
        $("err").style.display = msg ? "block" : "none";
      }

      function setPill(id, ok) {
        const el = $(id);
        el.classList.remove("ok", "bad");
        el.classList.add(ok ? "ok" : "bad");
      }

      function toggleEl(id) {
        const el = $(id);
        el.addEventListener("click", () => {
          const on = el.getAttribute("data-on") === "true";
          el.setAttribute("data-on", (!on).toString());
        });
      }

      async function api(path, body) {
        const res = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          let detail = "";
          try {
            const json = await res.json();
            detail = json.detail ? String(json.detail) : JSON.stringify(json);
          } catch (_) {
            detail = await res.text();
          }
          throw new Error(detail || `HTTP ${res.status}`);
        }
        return await res.json();
      }

      let state = { groups: [], selected: null, onboarding_steps: [] };

      function renderBroadcastTargets(defaultGroupId) {
        const wrap = $("broadcast_targets");
        wrap.innerHTML = "";
        const selected = new Set((state.broadcast_targets || []).map(Number));
        for (const g of state.groups) {
          const id = Number(g.group_id);
          const label = document.createElement("label");
          label.className = "check";
          const input = document.createElement("input");
          input.type = "checkbox";
          input.dataset.gid = String(id);
          input.checked = selected.has(id) || id === Number(defaultGroupId);
          input.addEventListener("change", () => {
            const gid = Number(input.dataset.gid);
            const next = new Set((state.broadcast_targets || []).map(Number));
            if (input.checked) next.add(gid);
            else next.delete(gid);
            state.broadcast_targets = Array.from(next);
          });
          const name = document.createElement("div");
          name.textContent = g.group_name || String(g.group_id);
          label.appendChild(input);
          label.appendChild(name);
          wrap.appendChild(label);
        }

        // Ensure default is selected on first render.
        if (!state.broadcast_targets || !state.broadcast_targets.length) {
          state.broadcast_targets = [Number(defaultGroupId)];
        }
      }

      function renderGroups() {
        const sel = $("groupSelect");
        sel.innerHTML = "";
        if (!state.groups.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No groups available";
          sel.appendChild(opt);
          return;
        }
        for (const g of state.groups) {
          const opt = document.createElement("option");
          opt.value = String(g.group_id);
          opt.textContent = g.group_name || String(g.group_id);
          sel.appendChild(opt);
        }
        sel.value = String(state.groups[0].group_id);
        selectGroup(sel.value);
      }

      function selectGroup(groupIdStr) {
        const gid = Number(groupIdStr);
        state.selected = state.groups.find((g) => g.group_id === gid) || null;
        if (!state.selected) return;

        $("preflight").style.display = "block";
        $("settings").style.display = "block";
        $("onboarding").style.display = "block";
        $("buttons").style.display = "block";
        $("broadcast").style.display = "block";
        $("rules").style.display = "block";
        $("tickets").style.display = "block";

        const pf = state.selected.preflight || {};
        setPill("pf_admin", !!pf.bot_admin);
        setPill("pf_restrict", !!pf.restrict_ok);
        setPill("pf_delete", !!pf.delete_ok);
        setPill("pf_joinreq", !!pf.join_by_request);
        setPill("pf_invite", !!pf.invite_ok);

        const s = state.selected.settings || {};
        $("verification_enabled").setAttribute("data-on", (!!s.verification_enabled).toString());
        $("verification_timeout").value = String(s.verification_timeout || 300);
        $("action_on_timeout").value = s.action_on_timeout || "mute";
        $("join_gate_enabled").setAttribute("data-on", (!!s.join_gate_enabled).toString());
        $("antiflood_enabled").setAttribute("data-on", (!!s.antiflood_enabled).toString());
        $("antiflood_limit").value = String(s.antiflood_limit || 10);
        $("lock_links").setAttribute("data-on", (!!s.lock_links).toString());
        $("lock_media").setAttribute("data-on", (!!s.lock_media).toString());
        $("logs_mode").value = "";
	
	        const logsEnabled = !!(s.logs_enabled && s.logs_chat_id);
	        const dest = logsEnabled ? `Chat ${s.logs_chat_id}${s.logs_thread_id ? " • thread " + s.logs_thread_id : ""}` : "Off";
	        $("logs_current").textContent = dest;
	        $("logsTestBtn").disabled = !logsEnabled;

        const ob = state.selected.onboarding || {};
        $("onboarding_enabled").setAttribute("data-on", (!!ob.enabled).toString());
        $("onboarding_delay_seconds").value = String(ob.delay_seconds || 0);
        $("onboarding_text").value = String(ob.text || "");
        const pm = ob.parse_mode;
        $("onboarding_parse_mode").value = pm === null ? "" : (pm || "Markdown");
        state.onboarding_steps = [];
        renderOnboardingSteps();

        renderBroadcastTargets(gid);

        loadOnboardingDetail(gid).catch((e) => setError(String(e.message || e)));
        loadRules(gid).catch((e) => setError(String(e.message || e)));
        loadTickets(gid).catch((e) => setError(String(e.message || e)));
	        loadBroadcastHistory(gid).catch((e) => setError(String(e.message || e)));
      }

      async function bootstrap() {
        setError("");
        const data = await api("/api/app/bootstrap", { initData });
        state.groups = data.groups || [];
        renderGroups();
      }

      async function save() {
        if (!state.selected) return;
        setError("");
        const gid = state.selected.group_id;

        const payload = {
          initData,
          verification_enabled: $("verification_enabled").getAttribute("data-on") === "true",
          verification_timeout: Number($("verification_timeout").value || 300),
          action_on_timeout: $("action_on_timeout").value,
          join_gate_enabled: $("join_gate_enabled").getAttribute("data-on") === "true",
          antiflood_enabled: $("antiflood_enabled").getAttribute("data-on") === "true",
          antiflood_limit: Number($("antiflood_limit").value || 10),
          lock_links: $("lock_links").getAttribute("data-on") === "true",
          lock_media: $("lock_media").getAttribute("data-on") === "true",
          logs_mode: $("logs_mode").value || null,
        };

        const updated = await api(`/api/app/group/${gid}/settings`, payload);
        const idx = state.groups.findIndex((g) => g.group_id === gid);
        if (idx >= 0) state.groups[idx] = updated;

        const steps = [];
        steps.push({
          delay_seconds: Number($("onboarding_delay_seconds").value || 0),
          text: String($("onboarding_text").value || ""),
          parse_mode: $("onboarding_parse_mode").value || null,
        });
        for (const s of (state.onboarding_steps || [])) {
          steps.push({
            delay_seconds: Number(s.delay_seconds || 0),
            text: String(s.text || ""),
            parse_mode: s.parse_mode ? String(s.parse_mode) : null,
          });
        }
        const onboardingPayload = {
          initData,
          enabled: $("onboarding_enabled").getAttribute("data-on") === "true",
          steps,
        };
        await api(`/api/app/group/${gid}/onboarding/steps`, onboardingPayload);

        selectGroup(String(gid));

        if (tg && tg.showPopup) {
          tg.showPopup({ title: "Saved", message: "Settings updated.", buttons: [{ type: "ok" }] });
        }
      }

      function renderOnboardingSteps() {
        const wrap = $("onboarding_steps_list");
        if (!wrap) return;
        wrap.innerHTML = "";

        const steps = state.onboarding_steps || [];
        const addBtn = $("onboardingAddStepBtn");
        const removeBtn = $("onboardingRemoveStepBtn");
        if (addBtn) addBtn.disabled = steps.length >= 9;
        if (removeBtn) removeBtn.disabled = steps.length <= 0;

        if (!steps.length) {
          const div = document.createElement("div");
          div.className = "pill";
          div.textContent = "No extra steps";
          wrap.appendChild(div);
          return;
        }

        for (let idx = 0; idx < steps.length; idx++) {
          const step = steps[idx];
          const stepNo = idx + 2;

          const row = document.createElement("div");
          row.className = "check";
          row.style.flexDirection = "column";
          row.style.alignItems = "stretch";
          row.style.gap = "8px";

          const head = document.createElement("div");
          head.style.display = "flex";
          head.style.justifyContent = "space-between";
          head.style.alignItems = "center";

          const title = document.createElement("div");
          title.textContent = `Step ${stepNo}`;

          const meta = document.createElement("div");
          meta.className = "pill";
          meta.textContent = `delay ${(step.delay_seconds || 0)}s`;

          head.appendChild(title);
          head.appendChild(meta);

          const controls = document.createElement("div");
          controls.className = "actions";
          controls.style.width = "100%";

          const delayInput = document.createElement("input");
          delayInput.type = "number";
          delayInput.min = "0";
          delayInput.step = "10";
          delayInput.value = String(step.delay_seconds || 0);
          delayInput.style.flex = "1";
          delayInput.addEventListener("input", () => {
            step.delay_seconds = Number(delayInput.value || 0);
            meta.textContent = `delay ${(step.delay_seconds || 0)}s`;
          });

          const parseSelect = document.createElement("select");
          parseSelect.style.flex = "1";
          parseSelect.innerHTML = `
            <option value="Markdown">Markdown</option>
            <option value="HTML">HTML</option>
            <option value="">Plain</option>
          `;
          parseSelect.value = (step.parse_mode === null || step.parse_mode === undefined) ? "Markdown" : String(step.parse_mode);
          parseSelect.addEventListener("change", () => {
            step.parse_mode = parseSelect.value;
          });

          controls.appendChild(delayInput);
          controls.appendChild(parseSelect);

          const textarea = document.createElement("textarea");
          textarea.placeholder = "Step message…";
          textarea.value = String(step.text || "");
          textarea.addEventListener("input", () => {
            step.text = textarea.value;
          });

          row.appendChild(head);
          row.appendChild(controls);
          row.appendChild(textarea);
          wrap.appendChild(row);
        }
      }

      async function loadOnboardingDetail(groupId) {
        const res = await api(`/api/app/group/${groupId}/onboarding/get`, { initData });
        const ob = res.onboarding || {};

        $("onboarding_enabled").setAttribute("data-on", (!!ob.enabled).toString());

        const steps = ob.steps || [];
        if (steps.length) {
          const first = steps[0] || {};
          $("onboarding_delay_seconds").value = String(first.delay_seconds || 0);
          $("onboarding_text").value = String(first.text || "");
          const pm = first.parse_mode;
          $("onboarding_parse_mode").value = pm === null ? "" : (pm || "Markdown");

          state.onboarding_steps = steps.slice(1).map((s) => {
            const pm2 = s.parse_mode;
            return {
              delay_seconds: Number(s.delay_seconds || 0),
              text: String(s.text || ""),
              parse_mode: pm2 === null ? "" : (pm2 || "Markdown"),
            };
          });
        } else {
          state.onboarding_steps = [];
        }

        renderOnboardingSteps();
      }

		      async function sendBroadcast() {
		        if (!state.selected) return;
		        setError("");
		        const text = String($("broadcast_text").value || "").trim();
	        if (!text) {
	          setError("Announcement text is empty.");
	          return;
	        }
	        const delay_minutes = Number($("broadcast_delay_minutes").value || 0);
	        if (!Number.isFinite(delay_minutes) || delay_minutes < 0) {
	          setError("Delay must be a positive number of minutes.");
	          return;
	        }
	        const delay_seconds = Math.min(7 * 24 * 3600, Math.floor(delay_minutes * 60));
	        const parse_mode = $("broadcast_parse_mode").value || null;
	        const targets = Array.from(
	          document.querySelectorAll("#broadcast_targets input[type=checkbox]:checked")
	        ).map((el) => Number(el.dataset.gid));
        if (!targets.length) {
	          setError("Select at least one target group.");
	          return;
	        }

	        const when = delay_seconds > 0 ? `in ${delay_minutes} minute(s)` : "now";
	        const ok = window.confirm(`Send this announcement ${when} to ${targets.length} group(s)?`);
	        if (!ok) return;

	        const res = await api(`/api/app/broadcast`, {
	          initData,
	          group_ids: targets,
	          text,
	          delay_seconds,
	          parse_mode,
	          disable_web_page_preview: true,
	        });
	        $("broadcast_text").value = "";
        if (tg && tg.showPopup) {
          tg.showPopup({
            title: "Queued",
            message: `Broadcast queued (id ${res.broadcast_id}). Targets: ${res.total_targets}.`,
            buttons: [{ type: "ok" }],
          });
        }
	      }

	      async function loadBroadcastHistory(groupId) {
	        const res = await api(`/api/app/group/${groupId}/broadcasts`, { initData, limit: 15 });
	        renderBroadcastHistory(res.broadcasts || []);
	      }

	      function renderBroadcastHistory(items) {
	        const wrap = $("broadcast_history");
	        wrap.innerHTML = "";
	        if (!items.length) {
	          const div = document.createElement("div");
	          div.className = "pill";
	          div.textContent = "No broadcasts yet";
	          wrap.appendChild(div);
	          return;
	        }
	        for (const b of items) {
	          const row = document.createElement("div");
	          row.className = "check";
	          const left = document.createElement("div");
	          left.style.display = "flex";
	          left.style.flexDirection = "column";
	          left.style.gap = "2px";

	          const k = document.createElement("div");
	          const sched = b.scheduled_at || b.created_at || "";
	          const shortTime = sched ? String(sched).replace("T", " ").replace("Z", "") : "";
	          k.textContent = `#${b.id} • ${b.status}${shortTime ? " • " + shortTime : ""}`;

	          const d = document.createElement("div");
	          d.className = "d";
	          const tgt = b.target_status ? ` • this group: ${b.target_status}` : "";
	          d.textContent = `${b.text_preview || ""} • ${b.sent_count || 0}/${b.total_targets || 0} sent${tgt}`;

	          left.appendChild(k);
	          left.appendChild(d);
	          row.appendChild(left);
	          wrap.appendChild(row);
	        }
	      }

	      async function loadRules(groupId) {
	        const res = await api(`/api/app/group/${groupId}/rules`, { initData });
	        renderRules(res.rules || []);
	      }

      function renderRules(rules) {
        const wrap = $("rules_list");
        wrap.innerHTML = "";
        if (!rules.length) {
          const div = document.createElement("div");
          div.className = "pill";
          div.textContent = "No rules yet";
          wrap.appendChild(div);
          return;
        }
        for (const r of rules) {
          const row = document.createElement("div");
          row.className = "check";
          const left = document.createElement("div");
          left.style.display = "flex";
          left.style.flexDirection = "column";
          left.style.gap = "2px";
          const k = document.createElement("div");
          k.textContent = `${r.match_type}: ${r.pattern}`;
          const d = document.createElement("div");
          d.className = "d";
          const act = (r.actions && r.actions.length) ? r.actions[0].type : "action";
          d.textContent = `${act} • priority ${r.priority}`;
          left.appendChild(k);
          left.appendChild(d);

          const del = document.createElement("button");
          del.className = "btn secondary";
          del.style.width = "auto";
          del.textContent = "Delete";
          del.addEventListener("click", () => {
            if (!state.selected) return;
            api(`/api/app/group/${state.selected.group_id}/rules/delete`, { initData, rule_id: r.id })
              .then((res) => renderRules(res.rules || []))
              .catch((e) => setError(String(e.message || e)));
          });

          row.appendChild(left);
          row.appendChild(del);
          wrap.appendChild(row);
        }
      }

      async function addRule() {
        if (!state.selected) return;
        setError("");
        const gid = state.selected.group_id;
        const pattern = String($("rule_pattern").value || "").trim();
        if (!pattern) {
          setError("Rule pattern is empty.");
          return;
        }
        const match_type = $("rule_match_type").value;
        const action_type = $("rule_action_type").value;
        const payload = {
          initData,
          name: "Rule",
          match_type,
          pattern,
          action_type,
          case_sensitive: false,
          stop_processing: true,
          priority: 100,
          reply_text: null,
          mute_duration_seconds: null,
          log_text: null,
          sequence_key: null,
          sequence_trigger_key: null,
          ticket_subject: null,
        };
        if (action_type === "reply") payload.reply_text = String($("rule_reply_text").value || "").trim();
        if (action_type === "mute") payload.mute_duration_seconds = Number($("rule_mute_seconds").value || 300);
        if (action_type === "log") payload.log_text = String($("rule_log_text").value || "").trim();
        if (action_type === "start_sequence") payload.sequence_key = String($("rule_sequence_key").value || "").trim();
        if (action_type === "create_ticket") payload.ticket_subject = String($("rule_ticket_subject").value || "").trim();
        const res = await api(`/api/app/group/${gid}/rules/create`, payload);
        $("rule_pattern").value = "";
        $("rule_reply_text").value = "";
        $("rule_log_text").value = "";
        $("rule_ticket_subject").value = "";
        renderRules(res.rules || []);
        if (tg && tg.showPopup) {
          tg.showPopup({ title: "Added", message: "Rule created.", buttons: [{ type: "ok" }] });
        }
      }

      async function testRules() {
        if (!state.selected) return;
        setError("");
        const gid = state.selected.group_id;
        const text = String($("rules_test_text").value || "").trim();
        if (!text) {
          setError("Test text is empty.");
          return;
        }
        const res = await api(`/api/app/group/${gid}/rules/test`, { initData, text, limit: 10 });
        renderRulesTestResults(res.matches || []);
      }

      async function sendLogTest() {
        if (!state.selected) return;
        setError("");
        const gid = state.selected.group_id;
        const res = await api(`/api/app/group/${gid}/logs/test`, { initData });
        if (tg && tg.showPopup) {
          tg.showPopup({
            title: "Sent",
            message: `Test log sent to ${res.logs_chat_id}${res.logs_thread_id ? " (thread " + res.logs_thread_id + ")" : ""}.`,
            buttons: [{ type: "ok" }],
          });
        }
      }

      function renderRulesTestResults(matches) {
        const wrap = $("rules_test_results");
        wrap.innerHTML = "";
        if (!matches.length) {
          const div = document.createElement("div");
          div.className = "pill";
          div.textContent = "No matches";
          wrap.appendChild(div);
          return;
        }
        for (const m of matches) {
          const row = document.createElement("div");
          row.className = "check";
          const left = document.createElement("div");
          left.style.display = "flex";
          left.style.flexDirection = "column";
          left.style.gap = "2px";
          const k = document.createElement("div");
          k.textContent = `#${m.id} • ${m.match_type}: ${m.pattern}`;
          const d = document.createElement("div");
          d.className = "d";
          const acts = (m.actions || []).map((a) => a.type).join(", ") || "no actions";
          d.textContent = `priority ${m.priority} • actions: ${acts}${m.stop_processing ? " • stop" : ""}`;
          left.appendChild(k);
          left.appendChild(d);
          row.appendChild(left);
          wrap.appendChild(row);
        }
      }

      async function loadTickets(groupId) {
        const res = await api(`/api/app/group/${groupId}/tickets`, { initData, status: "open" });
        renderTickets(res.tickets || []);
      }

      function renderTickets(tickets) {
        const wrap = $("tickets_list");
        wrap.innerHTML = "";
        if (!tickets.length) {
          const div = document.createElement("div");
          div.className = "pill";
          div.textContent = "No open tickets";
          wrap.appendChild(div);
          return;
        }
        for (const t of tickets) {
          const row = document.createElement("div");
          row.className = "check";
          const left = document.createElement("div");
          left.style.display = "flex";
          left.style.flexDirection = "column";
          left.style.gap = "2px";
          const k = document.createElement("div");
          k.textContent = `#${t.id} • user ${t.user_id}`;
          const d = document.createElement("div");
          d.className = "d";
          const subject = (t.subject || "").trim() || "(no subject)";
          d.textContent = `${subject}${t.created_at ? " • " + t.created_at : ""}`;
          left.appendChild(k);
          left.appendChild(d);
          row.appendChild(left);
          wrap.appendChild(row);
        }
      }

      if (!tg || !initData) {
        $("notg").style.display = "block";
      } else {
        tg.ready();
        try { tg.expand(); } catch (_) {}

        toggleEl("verification_enabled");
        toggleEl("join_gate_enabled");
        toggleEl("antiflood_enabled");
        toggleEl("lock_links");
	        toggleEl("lock_media");
	        toggleEl("onboarding_enabled");
	        renderOnboardingSteps();

        function onRuleActionChange() {
          const t = $("rule_action_type").value;
          $("rule_reply_wrap").style.display = t === "reply" ? "block" : "none";
          $("rule_mute_wrap").style.display = t === "mute" ? "flex" : "none";
          $("rule_log_wrap").style.display = t === "log" ? "block" : "none";
          $("rule_sequence_wrap").style.display = t === "start_sequence" ? "flex" : "none";
          $("rule_ticket_wrap").style.display = t === "create_ticket" ? "flex" : "none";
        }
        $("rule_action_type").addEventListener("change", onRuleActionChange);
        onRuleActionChange();

	        $("groupSelect").addEventListener("change", (e) => selectGroup(e.target.value));
	        $("onboardingAddStepBtn").addEventListener("click", () => {
	          const steps = state.onboarding_steps || [];
	          if (steps.length >= 9) return;
	          steps.push({ delay_seconds: 0, text: "", parse_mode: "Markdown" });
	          state.onboarding_steps = steps;
	          renderOnboardingSteps();
	        });
	        $("onboardingRemoveStepBtn").addEventListener("click", () => {
	          const steps = state.onboarding_steps || [];
	          if (!steps.length) return;
	          steps.pop();
	          state.onboarding_steps = steps;
	          renderOnboardingSteps();
	        });
	        $("saveBtn").addEventListener("click", () => save().catch((e) => setError(String(e.message || e))));
        $("reloadBtn").addEventListener("click", () => bootstrap().catch((e) => setError(String(e.message || e))));
        $("broadcastBtn").addEventListener("click", () => sendBroadcast().catch((e) => setError(String(e.message || e))));
        $("broadcastAllBtn").addEventListener("click", () => {
          state.broadcast_targets = state.groups.map((g) => Number(g.group_id));
          renderBroadcastTargets(state.selected ? state.selected.group_id : 0);
        });
	        $("broadcastNoneBtn").addEventListener("click", () => {
	          state.broadcast_targets = [];
	          renderBroadcastTargets(state.selected ? state.selected.group_id : 0);
	        });
        $("broadcastHistoryBtn").addEventListener("click", () => {
          if (!state.selected) return;
          loadBroadcastHistory(state.selected.group_id).catch((e) => setError(String(e.message || e)));
        });
        $("logsTestBtn").addEventListener("click", () => sendLogTest().catch((e) => setError(String(e.message || e))));
        $("ruleAddBtn").addEventListener("click", () => addRule().catch((e) => setError(String(e.message || e))));
        $("rulesTestBtn").addEventListener("click", () => testRules().catch((e) => setError(String(e.message || e))));
        $("ticketsRefreshBtn").addEventListener("click", () => {
          if (!state.selected) return;
          loadTickets(state.selected.group_id).catch((e) => setError(String(e.message || e)));
        });

        bootstrap().catch((e) => setError(String(e.message || e)));
      }
    </script>
  </body>
</html>
