<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Mercle Bot</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ===== DESIGN SYSTEM ===== */
    :root {
      --bg: var(--tg-theme-bg-color, #1c1c1e);
      --bg-secondary: var(--tg-theme-secondary-bg-color, #2c2c2e);
      --bg-secondary-rgb: 44, 44, 46;
      --bg-tertiary: #3a3a3c;
      --text: var(--tg-theme-text-color, #ffffff);
      --text-secondary: var(--tg-theme-hint-color, #8e8e93);
      --accent: var(--tg-theme-button-color, #0a84ff);
      --accent-text: var(--tg-theme-button-text-color, #ffffff);
      --success: #30d158;
      --warning: #ff9f0a;
      --danger: #ff453a;
      --separator: rgba(255, 255, 255, 0.1);
      --radius: 12px;
      --spacing: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg);
      border-bottom: 1px solid var(--separator);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-back {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: none;
      color: var(--accent);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    }

    .header-back:active { opacity: 0.6; }

    .header-title {
      font-size: 17px;
      font-weight: 600;
      flex: 1;
    }

    .hidden { display: none !important; }

    /* Status Page - No Scroll, Single Screen */
    .status-page {
      padding: 0 16px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      height: 100%;
    }

    .status-header {
      text-align: center;
      padding: 20px 0;
    }

    .bot-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent);
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .bot-name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .bot-username {
      font-size: 15px;
      color: var(--text-secondary);
    }

    /* Cards */
    .card {
      background: rgba(var(--bg-secondary-rgb, 44, 44, 46), 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.08);
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .card-section {
      padding: 16px;
      border-bottom: 1px solid var(--separator);
    }

    .card-section:last-child {
      border-bottom: none;
    }

    .card-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
    }

    .card-row:first-child {
      padding-top: 0;
    }

    .card-row:last-child {
      padding-bottom: 0;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .icon-success { background: rgba(48, 209, 88, 0.15); color: var(--success); }
    .icon-danger { background: rgba(255, 69, 58, 0.15); color: var(--danger); }
    .icon-warning { background: rgba(255, 159, 10, 0.15); color: var(--warning); }
    .icon-info { background: rgba(10, 132, 255, 0.15); color: var(--accent); }

    .card-content {
      flex: 1;
      min-width: 0;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .card-value {
      font-size: 15px;
      color: var(--text-secondary);
      text-align: right;
    }

    .status-verified { color: var(--success); }
    .status-unverified { color: var(--danger); }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px 20px;
      border-radius: var(--radius);
      border: none;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:active { opacity: 0.6; }

    .btn-primary {
      background: var(--accent);
      color: var(--accent-text);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text);
    }

    .link {
      color: var(--accent);
      text-decoration: none;
      font-size: 15px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .link:active { opacity: 0.6; }

    /* Info Pages */
    .info-page {
      padding: 20px 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    .info-page h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .info-page h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 12px;
    }

    .info-page p {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .info-page ul {
      margin: 12px 0;
      padding-left: 20px;
    }

    .info-page li {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    /* Group Selection */
    .search-box {
      padding: 16px;
      background: var(--bg);
    }

    .search-input {
      width: 100%;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--separator);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 15px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .group-list {
      padding: 0 16px;
    }

    .group-item {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .group-item:active { opacity: 0.6; }

    .group-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .group-info {
      flex: 1;
      min-width: 0;
    }

    .group-name {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .group-stats {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Dashboard */
    .dashboard {
      padding: 16px;
    }

    .dashboard-header {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      text-align: center;
    }

    .dashboard-group-name {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .dashboard-stats {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .dashboard-card {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: opacity 0.2s;
      text-align: center;
    }

    .dashboard-card:active { opacity: 0.6; }

    .dashboard-card-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .dashboard-card-title {
      font-size: 15px;
      font-weight: 600;
    }

    /* Detail Views */
    .detail-view {
      padding: 16px;
    }

    .detail-card {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
    }

    .detail-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--separator);
      border-radius: 8px;
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
    }

    .toggle {
      width: 51px;
      height: 31px;
      background: var(--bg-tertiary);
      border-radius: 16px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle.on {
      background: var(--success);
    }

    .toggle-knob {
      width: 27px;
      height: 27px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: left 0.3s;
    }

    .toggle.on .toggle-knob {
      left: 22px;
    }

    @media (max-width: 640px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Global Header (shows on inner pages) -->
    <div id="globalHeader" class="header hidden">
      <button class="header-back" onclick="goBack()">‚Üê</button>
      <div id="headerTitle" style="flex: 1; font-size: 17px; font-weight: 600;">Page</div>
    </div>

    <!-- Status Page -->
    <div id="statusView" class="status-page">
      <div id="statusContent"></div>
    </div>

    <!-- Group Selection View -->
    <div id="groupSelectionView" class="hidden">
      <div class="search-box">
        <input 
          type="text" 
          class="search-input" 
          id="groupSearch" 
          placeholder="Search groups..."
          oninput="filterGroups()"
        />
      </div>
      <div class="group-list" id="groupList"></div>
      <div class="empty-state hidden" id="noGroupsState">
        <div class="empty-icon">üì≠</div>
        <div>No groups found</div>
        <div style="font-size: 13px; margin-top: 8px;">Add the bot to a group to get started</div>
      </div>
    </div>

    <!-- Dashboard View (Group Settings) -->
    <div id="dashboardView" class="hidden">
      <div id="dashboardContent"></div>
    </div>

    <!-- Info Pages -->
    <div id="whyVerificationView" class="hidden info-page"></div>
    <div id="howToUnlockView" class="hidden info-page"></div>
    <div id="aboutSettingsView" class="hidden info-page"></div>
    <div id="privacyPolicyView" class="hidden info-page"></div>
    <div id="faqView" class="hidden info-page"></div>

    <!-- Settings View -->
    <div id="settingsView" class="hidden detail-view"></div>

    <!-- Tickets View -->
    <div id="ticketsView" class="hidden detail-view"></div>

    <!-- Analytics View -->
    <div id="analyticsView" class="hidden detail-view"></div>

    <!-- Rules View -->
    <div id="rulesView" class="hidden detail-view"></div>

    <!-- Onboarding View -->
    <div id="onboardingView" class="hidden detail-view"></div>

    <!-- Account Details View -->
    <div id="accountDetailsView" class="hidden status-page">
      <div id="accountDetailsContent"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    const initData = tg?.initData || "";

    const state = {
      groups: [],
      selectedGroup: null,
      currentView: 'status',
      viewHistory: [],
      verification: null,
      user: null,
      botInfo: null,
    };

    // ===== API =====
    async function api(path, body = {}) {
      const res = await fetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...body, initData }),
      });
      
      if (!res.ok) {
        const error = await res.json().catch(() => ({ detail: 'Unknown error' }));
        throw new Error(error.detail || `HTTP ${res.status}`);
      }
      
      return await res.json();
    }

    function showError(message) {
      if (tg?.showPopup) {
        tg.showPopup({ title: 'Error', message, buttons: [{ type: 'ok' }] });
      } else {
        alert(message);
      }
    }

    function showSuccess(message) {
      if (tg?.showPopup) {
        tg.showPopup({ title: 'Success', message, buttons: [{ type: 'ok' }] });
      } else {
        alert(message);
      }
    }

    // ===== NAVIGATION =====
    function showView(viewName, addToHistory = true) {
      // Hide all views
      document.querySelectorAll('[id$="View"]').forEach(view => {
        if (view.id !== 'globalHeader') {
          view.classList.add('hidden');
        }
      });

      const view = document.getElementById(viewName + 'View');
      if (view) {
        view.classList.remove('hidden');
      }

      // Handle global header visibility
      const globalHeader = document.getElementById('globalHeader');
      const headerTitle = document.getElementById('headerTitle');
      
      // Pages that should NOT show the header (main pages)
      const noHeaderPages = ['status'];
      
      if (globalHeader && headerTitle) {
        if (noHeaderPages.includes(viewName)) {
          globalHeader.classList.add('hidden');
        } else {
          globalHeader.classList.remove('hidden');
          
          // Set header title based on view
          const titles = {
            'groupSelection': 'Select Group',
            'dashboard': state.selectedGroup?.group_name || 'Group Settings',
            'whyVerification': 'Why Verification?',
            'howToUnlock': 'How to Unlock',
            'aboutSettings': 'About Settings',
            'privacyPolicy': 'Privacy Policy',
            'faq': 'FAQ',
            'settings': 'Configure Bot',
            'tickets': 'Tickets',
            'analytics': 'Analytics',
            'rules': 'Rules',
            'onboarding': 'Onboarding',
            'accountDetails': 'Settings',
          };
          headerTitle.textContent = titles[viewName] || 'Mercle Bot';
        }
      }
      
      // Render specific views
      if (viewName === 'accountDetails') {
        renderAccountDetails();
      }
      if (viewName === 'dashboard') {
        renderDashboard();
      }

      if (addToHistory && state.currentView !== viewName) {
        state.viewHistory.push(state.currentView);
      }
      state.currentView = viewName;
    }

    function goBack() {
      if (state.viewHistory.length > 0) {
        const previousView = state.viewHistory.pop();
        showView(previousView, false);
      } else {
        showView('status', false);
      }
    }

    // ===== DEMO MODE =====
    const DEMO_MODE = true; // Set to false in production
    const SHOW_LOCKED_STATE = false; // Toggle between locked/unlocked state
    
    function loadDemoData() {
      state.groups = [
        { 
          group_id: -1001234567890, 
          group_name: "Crypto Traders Hub", 
          member_count: 1523, 
          settings: { 
            verification_enabled: true, 
            verification_timeout: 300, 
            action_on_timeout: 'kick', 
            antiflood_enabled: true, 
            antiflood_limit: 10, 
            raid_mode_enabled: false 
          } 
        },
        { 
          group_id: -1001234567891, 
          group_name: "NFT Community", 
          member_count: 892, 
          settings: { 
            verification_enabled: true, 
            verification_timeout: 600, 
            action_on_timeout: 'mute', 
            antiflood_enabled: false, 
            antiflood_limit: 20, 
            raid_mode_enabled: false 
          } 
        },
        { 
          group_id: -1001234567892, 
          group_name: "DeFi Discussion", 
          member_count: 2341, 
          settings: { 
            verification_enabled: false, 
            verification_timeout: 300, 
            action_on_timeout: 'kick', 
            antiflood_enabled: true, 
            antiflood_limit: 15, 
            raid_mode_enabled: true 
          } 
        },
        { 
          group_id: -1001234567893, 
          group_name: "Web3 Developers", 
          member_count: 567, 
          settings: { 
            verification_enabled: true, 
            verification_timeout: 300, 
            action_on_timeout: 'kick', 
            antiflood_enabled: true, 
            antiflood_limit: 10, 
            raid_mode_enabled: false 
          } 
        },
      ];
      
      if (SHOW_LOCKED_STATE) {
        // Unverified user - locked state
        state.verification = {
          is_verified: false,
          verified_until: null,
          mercle_user_id: null
        };
      } else {
        // Verified user - unlocked state
        state.verification = {
          is_verified: true,
          verified_until: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(),
          mercle_user_id: "mercle_demo_user_12345"
        };
      }
      
      state.user = {
        id: 123456789,
        username: "demo_user",
        first_name: "Demo",
        last_name: "User"
      };
    }

    // ===== STATUS PAGE =====
    async function loadStatus() {
      try {
        // Check if we have initData
        if (!initData || initData.trim() === '') {
          console.warn('No initData available - loading demo mode');
          
          if (DEMO_MODE) {
            loadDemoData();
            renderStatusPage();
            return;
          }
          
          const content = document.getElementById('statusContent');
          content.innerHTML = `
            <div class="card">
              <div class="card-section">
                <div class="card-row">
                  <div class="card-icon icon-warning">‚ö†Ô∏è</div>
                  <div class="card-content">
                    <div class="card-title">Open from Telegram</div>
                    <div class="card-subtitle">This Mini App must be opened from within Telegram.</div>
                  </div>
                </div>
                <p style="color: var(--text-secondary); font-size: 13px; margin-top: 12px;">
                  Please open this app through the bot's menu button or a Mini App link in Telegram.
                </p>
              </div>
            </div>
          `;
          return;
        }

        const data = await api('/api/app/bootstrap');
        console.log('Bootstrap data received:', data);
        state.groups = data.groups || [];
        state.verification = data.verification || {};
        state.user = data.user || {};
        
        console.log('State after loading:', {
          groupCount: state.groups.length,
          isVerified: state.verification.is_verified,
          userId: state.user.id
        });
        
        renderStatusPage();
      } catch (error) {
        console.error('Failed to load status:', error);
        const content = document.getElementById('statusContent');
        content.innerHTML = `
          <div class="card">
            <div class="card-section">
              <div class="card-row">
                <div class="card-icon icon-danger">‚ùå</div>
                <div class="card-content">
                  <div class="card-title">Error Loading Data</div>
                  <div class="card-subtitle">${error.message || 'Unknown error'}</div>
                </div>
              </div>
              <p style="color: var(--text-secondary); font-size: 13px; margin-top: 12px;">
                Please try closing and reopening the Mini App. If the problem persists, contact support.
              </p>
            </div>
          </div>
          <button class="btn btn-primary" onclick="loadStatus()" style="margin-top: 16px;">
            üîÑ Retry
          </button>
        `;
      }
    }

    function renderStatusPage() {
      const content = document.getElementById('statusContent');
      const isVerified = state.verification.is_verified;
      const groupCount = state.groups.length;
      
      if (isVerified) {
        // Verified user view - Clean, intuitive design
        const verifiedUntil = state.verification.verified_until;
        const mercleId = state.verification.mercle_user_id || 'N/A';
        const timeRemaining = verifiedUntil ? formatTimeRemaining(verifiedUntil) : 'N/A';
        
        content.innerHTML = `
          <div style="display: flex; flex-direction: column; height: 100%; padding: 16px 0;">
            <!-- Top Section: Shield Icon + Status -->
            <div style="flex: 0 0 auto; text-align: center; padding: 16px 0 24px;">
              <div style="width: 100px; height: 100px; margin: 0 auto 14px; position: relative; display: flex; align-items: center; justify-content: center;">
                <!-- Shield background -->
                <div style="position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, #34C759 0%, #30D158 100%); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); box-shadow: 0 8px 24px rgba(52, 199, 89, 0.4);"></div>
                <!-- Checkmark -->
                <div style="position: relative; z-index: 1; font-size: 48px; color: white; font-weight: bold;">‚úì</div>
              </div>
              <div style="font-size: 22px; font-weight: 700; margin-bottom: 6px; color: var(--text);">Verified</div>
              <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.5;">
                You can manage bot settings for your groups.
              </div>
            </div>

            <!-- Middle Section: Access Menu (Takes remaining space) -->
            <div style="flex: 1 1 auto; display: flex; flex-direction: column;">
              <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; padding: 0 4px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Access</div>
              
              <!-- Groups Item -->
              <div class="card" onclick="openGroupSelection()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
                <div class="card-section" style="padding: 14px 16px;">
                  <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(52, 199, 89, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                      üë•
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Groups</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">${groupCount} available ¬∑ Configure bot settings</div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                  </div>
                </div>
              </div>

              <!-- Settings Item -->
              <div class="card" onclick="showView('accountDetails')" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
                <div class="card-section" style="padding: 14px 16px;">
                  <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(142, 142, 147, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                      ‚öôÔ∏è
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Settings</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">Account ¬∑ Verification ¬∑ Data</div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                  </div>
                </div>
              </div>

              <!-- Mini Apps Item -->
              <div class="card" style="opacity: 0.5; cursor: not-allowed;">
                <div class="card-section" style="padding: 14px 16px;">
                  <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(142, 142, 147, 0.1); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                      üéÆ
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Mini Games</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">Coming soon</div>
                    </div>
                    <div style="padding: 3px 8px; background: rgba(142, 142, 147, 0.2); border-radius: 8px; font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Soon</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Section: CTA Button + Footer (Stick to bottom) -->
            <div style="margin-top: auto; padding-top: 16px; padding-bottom: 20px;">
              <button class="btn btn-primary" onclick="openGroupSelection()" style="margin-bottom: 16px; font-size: 16px; padding: 14px 24px; border-radius: 12px; box-shadow: 0 4px 16px rgba(10, 132, 255, 0.3);">
                Manage Groups (${groupCount})
              </button>

              <div style="text-align: center;">
                <a class="link" onclick="showView('privacyPolicy')" style="font-size: 12px;">Privacy Policy</a>
                <span style="color: var(--text-secondary); margin: 0 8px;">‚Ä¢</span>
                <a class="link" onclick="showView('faq')" style="font-size: 12px;">FAQ</a>
              </div>
            </div>
          </div>
        `;
      } else {
        // Unverified user view - Clean, intuitive design with proper spacing
        content.innerHTML = `
          <div style="display: flex; flex-direction: column; height: 100%; padding: 16px 0;">
            <!-- Top Section: Shield Icon + Status -->
            <div style="flex: 0 0 auto; text-align: center; padding: 24px 0 20px;">
              <div style="width: 120px; height: 120px; margin: 0 auto 18px; position: relative; display: flex; align-items: center; justify-content: center;">
                <!-- Shield background -->
                <div style="position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, #FF9500 0%, #FF9F0A 100%); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); box-shadow: 0 12px 32px rgba(255, 149, 0, 0.4);"></div>
                <!-- Checkmark -->
                <div style="position: relative; z-index: 1; font-size: 56px; color: white; font-weight: bold;">‚úì</div>
              </div>
              <div style="font-size: 24px; font-weight: 700; margin-bottom: 10px; color: var(--text);">Verification Required</div>
              <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6; padding: 0 20px;">
                Verify to manage bot settings for your groups.
              </div>
            </div>

            <!-- Middle Section: Info Cards -->
            <div style="flex: 1 1 auto; display: flex; flex-direction: column; justify-content: center; padding: 0 0 16px;">
              <div class="card" style="margin-bottom: 12px;">
                <div class="card-section" style="padding: 16px;">
                  <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(10, 132, 255, 0.15); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">
                      ‚ö°
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Quick & Secure</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">Takes less than a minute</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="card">
                <div class="card-section" style="padding: 16px;">
                  <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(52, 199, 89, 0.15); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">
                      üîì
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Full Access</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">Manage groups, settings & more</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Section: CTA Button + Footer (Stick to bottom) -->
            <div style="margin-top: auto; padding-top: 16px; padding-bottom: 20px;">
              <button class="btn btn-primary" onclick="startVerification()" style="margin-bottom: 16px; font-size: 17px; padding: 15px 32px; border-radius: 12px; box-shadow: 0 6px 20px rgba(10, 132, 255, 0.35);">
                Verify Now
              </button>

              <div style="text-align: center;">
                <a class="link" onclick="showView('privacyPolicy')" style="font-size: 12px;">Privacy Policy</a>
                <span style="color: var(--text-secondary); margin: 0 8px;">‚Ä¢</span>
                <a class="link" onclick="showView('faq')" style="font-size: 12px;">FAQ</a>
              </div>
            </div>
          </div>
        `;
      }
    }

    function renderAccountDetails() {
      const content = document.getElementById('accountDetailsContent');
      const verifiedUntil = state.verification.verified_until;
      const mercleId = state.verification.mercle_user_id || 'N/A';
      const timeRemaining = verifiedUntil ? formatTimeRemaining(verifiedUntil) : 'N/A';
      const userId = state.user.id || 'N/A';
      const username = state.user.username ? `@${state.user.username}` : 'No username';
      const firstName = state.user.first_name || 'User';
      
      content.innerHTML = `
        <div style="display: flex; flex-direction: column; height: 100%; padding: 16px 0;">
          <!-- Account Section -->
          <div style="flex: 0 0 auto; margin-bottom: 20px;">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; padding: 0 4px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Account</div>
            <div class="card">
              <div class="card-section" style="padding: 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--accent) 0%, #0066cc 100%); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(10, 132, 255, 0.25);">
                    üë§
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 17px; font-weight: 600; margin-bottom: 2px; color: var(--text);">${firstName}</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">${username}</div>
                  </div>
                </div>
              </div>
              <div class="card-section" style="padding: 14px 16px; border-top: 1px solid var(--separator);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 14px; color: var(--text-secondary);">User ID</span>
                  <span style="font-size: 14px; font-weight: 500; color: var(--text);">${userId}</span>
                </div>
              </div>
              <div class="card-section" style="padding: 14px 16px; border-top: 1px solid var(--separator);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 14px; color: var(--text-secondary);">Mercle ID</span>
                  <span style="font-size: 13px; font-weight: 500; color: var(--text); font-family: monospace; background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px;">${mercleId}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Verification Section -->
          <div style="flex: 0 0 auto; margin-bottom: 20px;">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; padding: 0 4px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Verification</div>
            <div class="card">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 14px; color: var(--text-secondary);">Status</span>
                  <span style="font-size: 14px; font-weight: 600; color: var(--success);">‚úì Verified</span>
                </div>
              </div>
              <div class="card-section" style="padding: 14px 16px; border-top: 1px solid var(--separator);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 14px; color: var(--text-secondary);">Valid for</span>
                  <span style="font-size: 14px; font-weight: 500; color: var(--text);">${timeRemaining}</span>
                </div>
              </div>
              <div class="card-section" style="padding: 14px 16px; border-top: 1px solid var(--separator);" onclick="startVerification()" style="cursor: pointer;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                  <span style="font-size: 14px; color: var(--accent);">üîÑ Re-verify Account</span>
                  <span style="font-size: 16px; color: var(--text-secondary);">‚Ä∫</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Spacer -->
          <div style="flex: 1 1 auto;"></div>

          <!-- Data Section -->
          <div style="flex: 0 0 auto;">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; padding: 0 4px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Data</div>
            <div class="card" style="border: 1px solid rgba(255, 69, 58, 0.2);">
              <div class="card-section" style="padding: 14px 16px;" onclick="confirmDeleteData()">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                  <div>
                    <div style="font-size: 14px; color: var(--danger); font-weight: 500;">üóëÔ∏è Delete My Data</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">Remove all your information</div>
                  </div>
                  <span style="font-size: 16px; color: var(--text-secondary);">‚Ä∫</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function formatTimeRemaining(verifiedUntil) {
      try {
        const expiryDate = new Date(verifiedUntil);
        const now = new Date();
        const diff = expiryDate - now;
        
        if (diff <= 0) return 'Expired';
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        
        if (days > 0) {
          return `${days}d ${hours}h remaining`;
        } else {
          return `${hours}h remaining`;
        }
      } catch (e) {
        return 'N/A';
      }
    }

    function startVerification() {
      try {
        // Close the Mini App - user will interact with bot in DM
        if (tg?.close) {
          tg.close();
        } else {
          showError('Please open this app from Telegram');
        }
      } catch (error) {
        console.error('Error closing Mini App:', error);
        showError('Failed to close app: ' + error.message);
      }
    }

    function confirmDeleteData() {
      if (tg?.showConfirm) {
        tg.showConfirm(
          'Are you sure you want to delete all your data? This action cannot be undone.',
          async (confirmed) => {
            if (confirmed) {
              await deleteMyData();
            }
          }
        );
      } else {
        if (confirm('Are you sure you want to delete all your data? This action cannot be undone.')) {
          deleteMyData();
        }
      }
    }

    async function deleteMyData() {
      try {
        await api('/api/app/delete-my-data');
        showSuccess('Your data has been deleted.');
        if (tg?.close) {
          setTimeout(() => tg.close(), 1000);
        }
      } catch (error) {
        showError('Failed to delete data: ' + error.message);
      }
    }

    // ===== INFO PAGES =====
    function showWhyVerification() {
      const view = document.getElementById('whyVerificationView');
      view.innerHTML = `
        <h2>Why Verification is Needed</h2>
        
        <h3>Security & Trust</h3>
        <p>Verification ensures that only real, authenticated users can access group management features. This protects your communities from unauthorized access and malicious actors.</p>
        
        <h3>Spam Prevention</h3>
        <p>By requiring biometric verification through Mercle SDK, we prevent bots, spam accounts, and automated attacks from infiltrating your groups.</p>
        
        <h3>Privacy Protection</h3>
        <p>Verification helps us maintain a secure environment where your personal data and group settings are protected from unauthorized modifications.</p>
        
        <h3>Compliance</h3>
        <p>Our verification system ensures compliance with Telegram's terms of service and data protection regulations.</p>
      `;
    }

    function showHowToUnlock() {
      const view = document.getElementById('howToUnlockView');
      view.innerHTML = `
        <h2>How to Unlock Access</h2>
        
        <h3>Step 1: Start Verification</h3>
        <p>Click the "Verify My Account" button on the main page. This will open a chat with the bot.</p>
        
        <h3>Step 2: Complete Mercle SDK</h3>
        <p>Follow the instructions in the bot chat to complete biometric verification using Mercle SDK. This process is secure and takes only a few minutes.</p>
        
        <h3>Step 3: Access Unlocked</h3>
        <p>Once verified, you'll have full access to:</p>
        <ul>
          <li>Group management settings</li>
          <li>Admin dashboard and analytics</li>
          <li>Ticket system</li>
          <li>Rules and moderation tools</li>
          <li>All Mini App features</li>
        </ul>
        
        <h3>Verification Duration</h3>
        <p>Your verification is valid for 7 days. After that, you'll need to verify again to maintain access.</p>
      `;
    }

    function showAboutSettings() {
      const view = document.getElementById('aboutSettingsView');
      view.innerHTML = `
        <h2>About Settings</h2>
        
        <h3>What You'll Get Access To</h3>
        <p>Once verified, you'll be able to manage comprehensive settings for your groups:</p>
        
        <h3>Verification Settings</h3>
        <ul>
          <li>Enable/disable verification for new members</li>
          <li>Set verification timeout duration</li>
          <li>Choose action on timeout (kick or mute)</li>
        </ul>
        
        <h3>Anti-Flood Protection</h3>
        <ul>
          <li>Set message limits per minute</li>
          <li>Configure automatic actions for spammers</li>
          <li>Whitelist trusted users</li>
        </ul>
        
        <h3>Raid Mode</h3>
        <ul>
          <li>Emergency protection during raids</li>
          <li>Temporary restrictions on new members</li>
          <li>Enhanced moderation controls</li>
        </ul>
        
        <h3>Rules & Moderation</h3>
        <ul>
          <li>Create custom auto-moderation rules</li>
          <li>Set up keyword filters</li>
          <li>Configure automated actions</li>
        </ul>
        
        <h3>Onboarding</h3>
        <ul>
          <li>Welcome messages for new members</li>
          <li>Automated sequences</li>
          <li>Custom delays and formatting</li>
        </ul>
      `;
    }

    function showPrivacyPolicy() {
      const view = document.getElementById('privacyPolicyView');
      view.innerHTML = `
        <h2>Privacy Policy</h2>
        
        <h3>Data Collection</h3>
        <p>We collect only the minimum data necessary to provide our services:</p>
        <ul>
          <li>Telegram user ID and username</li>
          <li>Mercle verification ID (after verification)</li>
          <li>Group membership information</li>
          <li>Bot interaction logs</li>
        </ul>
        
        <h3>Data Usage</h3>
        <p>Your data is used exclusively for:</p>
        <ul>
          <li>Verifying your identity</li>
          <li>Managing group access and permissions</li>
          <li>Providing bot functionality</li>
          <li>Improving our services</li>
        </ul>
        
        <h3>Data Storage</h3>
        <p>All data is stored securely in encrypted databases. We implement industry-standard security measures to protect your information.</p>
        
        <h3>Data Sharing</h3>
        <p>We never sell or share your personal data with third parties. Verification is handled through Mercle SDK's secure infrastructure.</p>
        
        <h3>Your Rights</h3>
        <p>You have the right to:</p>
        <ul>
          <li>Access your data at any time</li>
          <li>Request data deletion (via "Delete My Data" button)</li>
          <li>Opt-out of data collection (by stopping bot usage)</li>
        </ul>
        
        <h3>Data Retention</h3>
        <p>Verification data expires after 7 days. Inactive accounts may be automatically purged after 90 days of inactivity.</p>
        
        <h3>Contact</h3>
        <p>For privacy concerns or data requests, contact us through the bot's support ticket system.</p>
      `;
    }

    function showFAQ() {
      const view = document.getElementById('faqView');
      view.innerHTML = `
        <h2>Frequently Asked Questions</h2>
        
        <h3>How long does verification take?</h3>
        <p>The verification process typically takes 2-3 minutes. You'll need to complete biometric verification through Mercle SDK.</p>
        
        <h3>How long is verification valid?</h3>
        <p>Verification is valid for 7 days. After that, you'll need to verify again to maintain access to admin features.</p>
        
        <h3>What if verification fails?</h3>
        <p>If verification fails, you can try again immediately. Make sure you're following the instructions carefully and have a stable internet connection.</p>
        
        <h3>Can I use the bot without verification?</h3>
        <p>Basic bot commands work without verification, but admin features, group management, and the Mini App require verification.</p>
        
        <h3>Is my biometric data stored?</h3>
        <p>No. Biometric verification is handled by Mercle SDK. We only receive a verification confirmation, not your actual biometric data.</p>
        
        <h3>What happens if I delete my data?</h3>
        <p>All your data will be permanently removed from our systems, including verification status, group memberships, and settings. This action cannot be undone.</p>
        
        <h3>Can I manage multiple groups?</h3>
        <p>Yes! Once verified, you can manage all groups where you have admin permissions.</p>
        
        <h3>What are the bot's permissions?</h3>
        <p>The bot needs admin permissions to manage members, delete messages, and restrict users. You can configure specific permissions in group settings.</p>
        
        <h3>How do I report a bug?</h3>
        <p>Use the ticket system in the bot to report bugs or issues. Our team will respond as soon as possible.</p>
        
        <h3>Is the bot free?</h3>
        <p>Yes, the bot is completely free to use for all features.</p>
      `;
    }

    // ===== GROUP SELECTION =====
    function openGroupSelection() {
      showView('groupSelection');
      renderGroups();
    }

    function renderGroups() {
      const list = document.getElementById('groupList');
      const noGroupsState = document.getElementById('noGroupsState');
      
      if (state.groups.length === 0) {
        list.innerHTML = '';
        noGroupsState.classList.remove('hidden');
        return;
      }

      noGroupsState.classList.add('hidden');
      
      list.innerHTML = state.groups.map(group => {
        const initial = (group.group_name || 'G')[0].toUpperCase();
        const memberCount = group.member_count || 0;
        
        return `
          <div class="group-item" onclick="selectGroup(${group.group_id})">
            <div class="group-avatar">${initial}</div>
            <div class="group-info">
              <div class="group-name">${group.group_name || `Group ${group.group_id}`}</div>
              <div class="group-stats">üë• ${memberCount.toLocaleString()} members</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterGroups() {
      const query = document.getElementById('groupSearch').value.toLowerCase();
      const items = document.querySelectorAll('.group-item');
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(query) ? 'flex' : 'none';
      });
    }

    function selectGroup(groupId) {
      state.selectedGroup = state.groups.find(g => g.group_id === groupId);
      showView('dashboard');
      renderDashboard();
    }

    // ===== DASHBOARD =====
    function renderDashboard() {
      if (!state.selectedGroup) return;
      
      const groupName = state.selectedGroup.group_name || `Group ${state.selectedGroup.group_id}`;
      const memberCount = state.selectedGroup.member_count || 0;
      const firstLetter = groupName.charAt(0).toUpperCase();
      const isVerified = state.selectedGroup.settings?.verification_enabled;

      const content = document.getElementById('dashboardContent');
      content.innerHTML = `
        <div style="display: flex; flex-direction: column; height: 100%; padding: 16px;">
          <!-- Group Header -->
          <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--separator);">
            <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, #5856D6 0%, #AF52DE 100%); display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 700; color: white; flex-shrink: 0;">
              ${firstLetter}
            </div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">
                <span style="font-size: 18px; font-weight: 700; color: var(--text);">${groupName}</span>
                ${isVerified ? '<span style="color: var(--accent);">‚úì</span>' : ''}
              </div>
              <div style="font-size: 13px; color: var(--text-secondary);">${memberCount.toLocaleString()} members</div>
            </div>
          </div>

          <!-- Settings Section -->
          <div style="flex: 1 1 auto;">
            <div style="font-size: 18px; font-weight: 700; margin-bottom: 14px; color: var(--text);">Settings</div>
            
            <!-- Configure Bot -->
            <div class="card" onclick="loadSettings()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(142, 142, 147, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    ‚öôÔ∏è
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Configure bot</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Admin</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>

            <!-- Tickets -->
            <div class="card" onclick="loadTickets()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(255, 204, 0, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    üé´
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Tickets</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Support</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>

            <!-- Analytics -->
            <div class="card" onclick="loadAnalytics()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(52, 199, 89, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    üìä
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Analytics</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">View stats</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>

            <!-- Rules -->
            <div class="card" onclick="loadRules()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(10, 132, 255, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    üìã
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Rules</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Auto-moderation</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>

            <!-- Onboarding -->
            <div class="card" onclick="loadOnboarding()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(255, 149, 0, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    üëã
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Onboarding</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Welcome flow</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ===== SETTINGS =====
    async function loadSettings() {
      if (!state.selectedGroup) return;
      showView('settings');
      const view = document.getElementById('settingsView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';
      
      try {
        const settings = state.selectedGroup.settings || {};
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">‚öôÔ∏è Configure Bot</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Manage verification and security settings for this group.</p>
            
            <div class="toggle-row">
              <span>Verification Enabled</span>
              <div class="toggle ${settings.verification_enabled ? 'on' : ''}" onclick="toggleSetting('verification_enabled')">
                <div class="toggle-knob"></div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Verification Timeout (seconds)</label>
              <input type="number" class="form-input" id="verificationTimeout" value="${settings.verification_timeout || 300}" />
            </div>
            
            <div class="toggle-row">
              <span>Kick Unverified Users</span>
              <div class="toggle ${settings.action_on_timeout === 'kick' ? 'on' : ''}" onclick="toggleSetting('kick_unverified')">
                <div class="toggle-knob"></div>
              </div>
            </div>
            
            <div class="toggle-row">
              <span>Anti-Flood Enabled</span>
              <div class="toggle ${settings.antiflood_enabled ? 'on' : ''}" onclick="toggleSetting('antiflood_enabled')">
                <div class="toggle-knob"></div>
              </div>
            </div>
            
            <div class="toggle-row">
              <span>Raid Mode</span>
              <div class="toggle ${settings.raid_mode_enabled ? 'on' : ''}" onclick="toggleSetting('raid_mode_enabled')">
                <div class="toggle-knob"></div>
              </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
          </div>
        `;
      } catch (error) {
        view.innerHTML = `<div style="padding: 20px; color: var(--danger);">Error: ${error.message}</div>`;
      }
    }

    async function saveSettings() {
      if (!state.selectedGroup) return;
      
      try {
        const groupId = state.selectedGroup.group_id;
        const settings = state.selectedGroup.settings || {};
        
        // Get all current toggle states
        const toggles = document.querySelectorAll('#settingsView .toggle');
        const verificationEnabled = toggles[0]?.classList.contains('on') ?? settings.verification_enabled;
        const kickUnverified = toggles[1]?.classList.contains('on') ?? (settings.action_on_timeout === 'kick');
        const antifloodEnabled = toggles[2]?.classList.contains('on') ?? settings.antiflood_enabled;
        const raidModeEnabled = toggles[3]?.classList.contains('on') ?? settings.raid_mode_enabled;
        
        const timeout = parseInt(document.getElementById('verificationTimeout').value) || 300;
        
        // Call API to save settings
        await api(`/api/app/group/${groupId}/settings`, {
          verification_enabled: verificationEnabled,
          verification_timeout: timeout,
          action_on_timeout: kickUnverified ? 'kick' : 'mute',
          antiflood_enabled: antifloodEnabled,
          raid_mode_enabled: raidModeEnabled
        });
        
        // Update local state
        state.selectedGroup.settings = {
          ...settings,
          verification_enabled: verificationEnabled,
          verification_timeout: timeout,
          action_on_timeout: kickUnverified ? 'kick' : 'mute',
          antiflood_enabled: antifloodEnabled,
          raid_mode_enabled: raidModeEnabled
        };
        
        showSuccess('Settings saved successfully');
      } catch (error) {
        console.error('Failed to save settings:', error);
        showError('Failed to save settings: ' + error.message);
      }
    }

    function toggleSetting(key) {
      // Toggle the visual state
      const toggle = event.target.closest('.toggle');
      if (toggle) {
        toggle.classList.toggle('on');
      }
    }

    // ===== TICKETS =====
    async function loadTickets() {
      if (!state.selectedGroup) return;
      showView('tickets');
      const view = document.getElementById('ticketsView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading tickets...</div>';
      
      try {
        const groupId = state.selectedGroup.group_id;
        const data = await api(`/api/app/group/${groupId}/tickets`);
        const tickets = data.tickets || [];
        
        if (tickets.length === 0) {
          view.innerHTML = `
            <div class="detail-card">
              <div class="detail-title">üé´ Support Tickets</div>
              <p style="color: var(--text-secondary);">Manage user support requests and tickets.</p>
              <div style="margin-top: 20px; text-align: center; color: var(--text-secondary);">
                No active tickets
              </div>
            </div>
          `;
          return;
        }
        
        const ticketHtml = tickets.map(t => `
          <div class="card-row" style="border-bottom: 1px solid var(--separator); padding: 12px 0;">
            <div class="card-content">
              <div class="card-title">#${t.id} - ${t.subject || 'No subject'}</div>
              <div class="card-subtitle">Status: ${t.status} | Priority: ${t.priority || 'normal'}</div>
            </div>
            <span style="color: ${t.status === 'open' ? 'var(--success)' : 'var(--text-secondary)'};">
              ${t.status === 'open' ? '‚óè' : '‚óã'}
            </span>
          </div>
        `).join('');
        
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üé´ Support Tickets (${tickets.length})</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Manage user support requests and tickets.</p>
            ${ticketHtml}
          </div>
        `;
      } catch (error) {
        console.error('Failed to load tickets:', error);
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üé´ Support Tickets</div>
            <p style="color: var(--text-secondary);">Manage user support requests and tickets.</p>
            <div style="margin-top: 20px; text-align: center; color: var(--text-secondary);">
              No active tickets
            </div>
          </div>
        `;
      }
    }

    // ===== ANALYTICS =====
    async function loadAnalytics() {
      if (!state.selectedGroup) return;
      showView('analytics');
      const view = document.getElementById('analyticsView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading analytics...</div>';
      
      try {
        const groupId = state.selectedGroup.group_id;
        const data = await api(`/api/app/group/${groupId}/analytics`);
        
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üìä Analytics</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">View group statistics and metrics.</p>
            
            <div class="card-row">
              <div class="card-content">
                <div class="card-title">Total Members</div>
                <div class="card-subtitle">${data.member_count || state.selectedGroup?.member_count || 0}</div>
              </div>
            </div>
            
            <div class="card-row">
              <div class="card-content">
                <div class="card-title">Verified Users</div>
                <div class="card-subtitle">${data.verified_count || 0}</div>
              </div>
            </div>
            
            <div class="card-row">
              <div class="card-content">
                <div class="card-title">Pending Verifications</div>
                <div class="card-subtitle">${data.pending_count || 0}</div>
              </div>
            </div>
            
            <div class="card-row">
              <div class="card-content">
                <div class="card-title">Warnings Issued</div>
                <div class="card-subtitle">${data.warning_count || 0}</div>
              </div>
            </div>
            
            <div class="card-row">
              <div class="card-content">
                <div class="card-title">Active Tickets</div>
                <div class="card-subtitle">${data.ticket_count || 0}</div>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load analytics:', error);
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üìä Analytics</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">View group statistics and metrics.</p>
            
            <div class="card-row">
              <div class="card-content">
                <div class="card-title">Total Members</div>
                <div class="card-subtitle">${state.selectedGroup?.member_count || 0}</div>
              </div>
            </div>
            
            <div style="margin-top: 16px; text-align: center; color: var(--text-secondary);">
              Unable to load detailed analytics
            </div>
          </div>
        `;
      }
    }

    // ===== RULES =====
    async function loadRules() {
      if (!state.selectedGroup) return;
      showView('rules');
      const view = document.getElementById('rulesView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading rules...</div>';
      
      try {
        const groupId = state.selectedGroup.group_id;
        const data = await api(`/api/app/group/${groupId}/rules`);
        const rules = data.rules || [];
        
        if (rules.length === 0) {
          view.innerHTML = `
            <div class="detail-card">
              <div class="detail-title">üìã Auto-Moderation Rules</div>
              <p style="color: var(--text-secondary); margin-bottom: 16px;">Create and manage automated moderation rules.</p>
              
              <div style="margin-top: 20px; text-align: center; color: var(--text-secondary);">
                No rules configured
              </div>
              
              <button class="btn btn-primary" style="margin-top: 16px;" onclick="showAddRuleForm()">
                + Add Rule
              </button>
            </div>
          `;
          return;
        }
        
        const rulesHtml = rules.map(r => `
          <div class="card-row" style="border-bottom: 1px solid var(--separator); padding: 12px 0;">
            <div class="card-content">
              <div class="card-title">${r.name || 'Unnamed Rule'}</div>
              <div class="card-subtitle">${r.match_type}: "${r.pattern}" ‚Üí ${r.action_type}</div>
            </div>
            <div class="toggle ${r.enabled ? 'on' : ''}" onclick="toggleRule(${r.id})">
              <div class="toggle-knob"></div>
            </div>
          </div>
        `).join('');
        
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üìã Auto-Moderation Rules (${rules.length})</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Create and manage automated moderation rules.</p>
            ${rulesHtml}
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="showAddRuleForm()">
              + Add Rule
            </button>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load rules:', error);
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üìã Auto-Moderation Rules</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Create and manage automated moderation rules.</p>
            
            <div style="margin-top: 20px; text-align: center; color: var(--text-secondary);">
              No rules configured
            </div>
            
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="showAddRuleForm()">
              + Add Rule
            </button>
          </div>
        `;
      }
    }

    async function toggleRule(ruleId) {
      // Toggle visual state
      const toggle = event.target.closest('.toggle');
      if (toggle) {
        toggle.classList.toggle('on');
        const enabled = toggle.classList.contains('on');
        
        try {
          const groupId = state.selectedGroup.group_id;
          await api(`/api/app/group/${groupId}/rules/${ruleId}/toggle`, { enabled });
        } catch (error) {
          // Revert toggle on error
          toggle.classList.toggle('on');
          showError('Failed to toggle rule: ' + error.message);
        }
      }
    }

    function showAddRuleForm() {
      const view = document.getElementById('rulesView');
      view.innerHTML = `
        <div class="detail-card">
          <div class="detail-title">üìã Add New Rule</div>
          
          <div class="form-group">
            <label class="form-label">Rule Name</label>
            <input type="text" class="form-input" id="ruleName" placeholder="e.g., Block spam links" />
          </div>
          
          <div class="form-group">
            <label class="form-label">Match Type</label>
            <select class="form-input" id="ruleMatchType">
              <option value="contains">Contains</option>
              <option value="exact">Exact Match</option>
              <option value="regex">Regex</option>
              <option value="starts_with">Starts With</option>
              <option value="ends_with">Ends With</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Pattern</label>
            <input type="text" class="form-input" id="rulePattern" placeholder="Text to match..." />
          </div>
          
          <div class="form-group">
            <label class="form-label">Action</label>
            <select class="form-input" id="ruleAction">
              <option value="delete">Delete Message</option>
              <option value="warn">Warn User</option>
              <option value="mute">Mute User</option>
              <option value="kick">Kick User</option>
              <option value="ban">Ban User</option>
            </select>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" style="flex: 1;" onclick="loadRules()">Cancel</button>
            <button class="btn btn-primary" style="flex: 1;" onclick="saveRule()">Save Rule</button>
          </div>
        </div>
      `;
    }

    async function saveRule() {
      if (!state.selectedGroup) return;
      
      try {
        const groupId = state.selectedGroup.group_id;
        const name = document.getElementById('ruleName').value.trim();
        const matchType = document.getElementById('ruleMatchType').value;
        const pattern = document.getElementById('rulePattern').value.trim();
        const actionType = document.getElementById('ruleAction').value;
        
        if (!name || !pattern) {
          showError('Please fill in all required fields');
          return;
        }
        
        // Use the correct endpoint for creating rules
        await api(`/api/app/group/${groupId}/rules/create`, {
          name,
          match_type: matchType,
          pattern,
          action_type: actionType,
          enabled: true,
          trigger: 'message_group'
        });
        
        showSuccess('Rule created successfully');
        loadRules(); // Reload rules list
      } catch (error) {
        console.error('Failed to save rule:', error);
        showError('Failed to save rule: ' + error.message);
      }
    }

    // ===== ONBOARDING =====
    async function loadOnboarding() {
      showView('onboarding');
      const view = document.getElementById('onboardingView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';
      
      try {
        const onboarding = state.selectedGroup?.onboarding || {};
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üëã Welcome Flow</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Configure welcome messages for new members.</p>
            
            <div class="toggle-row">
              <span>Enable Welcome Message</span>
              <div class="toggle ${onboarding.enabled ? 'on' : ''}" onclick="toggleOnboarding()">
                <div class="toggle-knob"></div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Welcome Message</label>
              <textarea class="form-textarea" id="onboardingText" placeholder="Enter welcome message...">${onboarding.text || ''}</textarea>
            </div>
            
            <div class="form-group">
              <label class="form-label">Delay (seconds)</label>
              <input type="number" class="form-input" id="onboardingDelay" value="${onboarding.delay_seconds || 0}" />
            </div>
            
            <button class="btn btn-primary" onclick="saveOnboarding()">Save Changes</button>
          </div>
        `;
      } catch (error) {
        view.innerHTML = `<div style="padding: 20px; color: var(--danger);">Error: ${error.message}</div>`;
      }
    }

    function toggleOnboarding() {
      const toggle = event.target.closest('.toggle');
      if (toggle) {
        toggle.classList.toggle('on');
      }
    }

    async function saveOnboarding() {
      if (!state.selectedGroup) return;
      
      try {
        const groupId = state.selectedGroup.group_id;
        
        // Get toggle state
        const toggle = document.querySelector('#onboardingView .toggle');
        const enabled = toggle?.classList.contains('on') ?? false;
        
        const text = document.getElementById('onboardingText').value.trim();
        const delaySeconds = parseInt(document.getElementById('onboardingDelay').value) || 0;
        
        // Call API to save onboarding settings
        await api(`/api/app/group/${groupId}/onboarding`, {
          enabled: enabled,
          text: text,
          delay_seconds: delaySeconds,
          parse_mode: 'HTML'
        });
        
        // Update local state
        state.selectedGroup.onboarding = {
          enabled: enabled,
          text: text,
          delay_seconds: delaySeconds,
          parse_mode: 'HTML'
        };
        
        showSuccess('Onboarding settings saved');
      } catch (error) {
        console.error('Failed to save onboarding:', error);
        showError('Failed to save: ' + error.message);
      }
    }

    // ===== INIT =====
    if (tg) {
      tg.ready();
      tg.expand();
      tg.enableClosingConfirmation();
    }

    // Load bot info and status
    (async () => {
      try {
        // Get bot info
        try {
          const botResponse = await fetch('/');
          const botData = await botResponse.json();
          state.botInfo = { username: 'mercleMerci_bot' }; // Default
        } catch (e) {
          console.warn('Failed to fetch bot info, using defaults:', e);
          state.botInfo = { username: 'mercleMerci_bot' };
        }
        
        // Hide global header on initial load (status page)
        const globalHeader = document.getElementById('globalHeader');
        if (globalHeader) globalHeader.classList.add('hidden');
        
        // Load user status
        await loadStatus();
      } catch (error) {
        console.error('Initialization error:', error);
        const content = document.getElementById('statusContent');
        if (content) {
          content.innerHTML = `
            <div class="card">
              <div class="card-section">
                <div class="card-row">
                  <div class="card-icon icon-danger">‚ùå</div>
                  <div class="card-content">
                    <div class="card-title">Initialization Failed</div>
                    <div class="card-subtitle">${error.message || 'Unknown error'}</div>
                  </div>
                </div>
                <p style="color: var(--text-secondary); font-size: 13px; margin-top: 12px;">
                  Please try reopening the Mini App from Telegram.
                </p>
              </div>
            </div>
            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 16px;">
              üîÑ Reload App
            </button>
          `;
        }
      }
    })();
  </script>
</body>
</html>
