<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Mercle Bot</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ===== DESIGN SYSTEM - ALWAYS DARK MODE ===== */
    :root {
      /* Force dark mode colors regardless of Telegram theme */
      --bg: #1c1c1e;
      --bg-secondary: #2c2c2e;
      --bg-secondary-rgb: 44, 44, 46;
      --bg-tertiary: #3a3a3c;
      --text: #ffffff;
      --text-secondary: #8e8e93;
      --accent: #0a84ff;
      --accent-text: #ffffff;
      --success: #30d158;
      --warning: #ff9f0a;
      --danger: #ff453a;
      --separator: rgba(255, 255, 255, 0.1);
      --radius: 12px;
      --spacing: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg);
      border-bottom: 1px solid var(--separator);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-back {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 20px;
      background: var(--bg-secondary);
      border: none;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      min-height: 36px;
    }
    
    .header-back-icon {
      font-size: 16px;
      color: var(--text-secondary);
    }

    .header-back:active { 
      background: var(--bg-tertiary);
      transform: scale(0.96);
    }

    .header-title {
      font-size: 17px;
      font-weight: 600;
      flex: 1;
    }

    .hidden { display: none !important; }

    /* Status Page - Flexible height with scroll if needed */
    .status-page {
      padding: 0 16px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .status-header {
      text-align: center;
      padding: 20px 0;
    }

    .bot-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent);
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .bot-name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .bot-username {
      font-size: 15px;
      color: var(--text-secondary);
    }

    /* Cards */
    .card {
      background: rgba(var(--bg-secondary-rgb, 44, 44, 46), 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.08);
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .card-section {
      padding: 16px;
      border-bottom: 1px solid var(--separator);
    }

    .card-section:last-child {
      border-bottom: none;
    }

    .card-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
    }

    .card-row:first-child {
      padding-top: 0;
    }

    .card-row:last-child {
      padding-bottom: 0;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .icon-success { background: rgba(48, 209, 88, 0.15); color: var(--success); }
    .icon-danger { background: rgba(255, 69, 58, 0.15); color: var(--danger); }
    .icon-warning { background: rgba(255, 159, 10, 0.15); color: var(--warning); }
    .icon-info { background: rgba(10, 132, 255, 0.15); color: var(--accent); }

    .card-content {
      flex: 1;
      min-width: 0;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .card-value {
      font-size: 15px;
      color: var(--text-secondary);
      text-align: right;
    }

    .status-verified { color: var(--success); }
    .status-unverified { color: var(--danger); }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px 20px;
      border-radius: var(--radius);
      border: none;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:active { opacity: 0.6; }

    .btn-primary {
      background: var(--accent);
      color: var(--accent-text);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text);
    }

    .link {
      color: var(--accent);
      text-decoration: none;
      font-size: 15px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .link:active { opacity: 0.6; }

    /* Info Pages */
    .info-page {
      padding: 20px 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    .info-page h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .info-page h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 12px;
    }

    .info-page p {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .info-page ul {
      margin: 12px 0;
      padding-left: 20px;
    }

    .info-page li {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    /* Group Selection */
    .search-box {
      padding: 16px;
      background: var(--bg);
    }

    .search-input {
      width: 100%;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--separator);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 15px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .group-list {
      padding: 0 16px;
    }

    .group-item {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .group-item:active { opacity: 0.6; }

    .group-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .group-info {
      flex: 1;
      min-width: 0;
    }

    .group-name {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .group-stats {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Dashboard */
    .dashboard {
      padding: 16px;
    }

    .dashboard-header {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      text-align: center;
    }

    .dashboard-group-name {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .dashboard-stats {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .dashboard-card {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: opacity 0.2s;
      text-align: center;
    }

    .dashboard-card:active { opacity: 0.6; }

    .dashboard-card-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .dashboard-card-title {
      font-size: 15px;
      font-weight: 600;
    }

    /* Detail Views */
    .detail-view {
      padding: 16px;
    }

    .detail-card {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
    }

    .detail-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group.has-error .form-input,
    .form-group.has-error .form-textarea,
    .form-group.has-error .form-select {
      border-color: var(--danger);
    }
    
    .form-error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    
    .form-group.has-error .form-error {
      display: block;
    }
    
    .required-indicator {
      color: var(--danger);
      margin-left: 2px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--separator);
      border-radius: 8px;
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
    }

    .toggle {
      width: 51px;
      height: 31px;
      background: var(--bg-tertiary);
      border-radius: 16px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle.on {
      background: var(--success);
    }

    .toggle-knob {
      width: 27px;
      height: 27px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: left 0.3s;
    }

    .toggle.on .toggle-knob {
      left: 22px;
    }

    @media (max-width: 640px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Global Header (shows on inner pages) -->
    <div id="globalHeader" class="header hidden">
      <button class="header-back" onclick="goBack()">
        <span class="header-back-icon">‚Üê</span>
        <span>Back</span>
      </button>
      <div id="headerTitle" style="flex: 1; font-size: 17px; font-weight: 600;">Page</div>
    </div>

    <!-- Status Page -->
    <div id="statusView" class="status-page">
      <div id="statusContent"></div>
    </div>

    <!-- Group Selection View -->
    <div id="groupSelectionView" class="hidden">
      <div class="search-box">
        <input 
          type="text" 
          class="search-input" 
          id="groupSearch" 
          placeholder="Search groups..."
          oninput="filterGroups()"
        />
      </div>
      <div class="group-list" id="groupList"></div>
      <div class="empty-state hidden" id="noGroupsState">
        <div class="empty-icon">üì≠</div>
        <div>No groups found</div>
        <div style="font-size: 13px; margin-top: 8px;">Add the bot to a group to get started</div>
      </div>
    </div>

    <!-- Dashboard View (Group Settings) -->
    <div id="dashboardView" class="hidden">
      <div id="dashboardContent"></div>
    </div>

    <!-- Info Pages -->
    <div id="whyVerificationView" class="hidden info-page"></div>
    <div id="howToUnlockView" class="hidden info-page"></div>
    <div id="aboutSettingsView" class="hidden info-page"></div>
    <div id="privacyPolicyView" class="hidden info-page"></div>
    <div id="faqView" class="hidden info-page"></div>

    <!-- Settings View -->
    <div id="settingsView" class="hidden detail-view"></div>

    <!-- Tickets View -->
    <div id="ticketsView" class="hidden detail-view"></div>

    <!-- Ticket Detail View -->
    <div id="ticketDetailView" class="hidden detail-view"></div>

    <!-- Analytics View -->
    <div id="analyticsView" class="hidden detail-view"></div>

    <!-- Rules View -->
    <div id="rulesView" class="hidden detail-view"></div>

    <!-- Onboarding View -->
    <div id="onboardingView" class="hidden detail-view"></div>

    <!-- Broadcast View -->
    <div id="broadcastView" class="hidden detail-view"></div>

    <!-- Account Details View -->
    <div id="accountDetailsView" class="hidden status-page">
      <div id="accountDetailsContent"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    const initData = tg?.initData || "";

    const state = {
      groups: [],
      selectedGroup: null,
      currentView: 'status',
      viewHistory: [],  // Array of {view: string, data: object} for proper back navigation
      verification: null,
      user: null,
      botInfo: null,
      // View-specific state
      currentTicketId: null,
      currentRuleId: null,
    };

    // ===== API =====
    async function api(path, body = {}) {
      const res = await fetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...body, initData }),
      });
      
      if (!res.ok) {
        const error = await res.json().catch(() => ({ detail: 'Unknown error' }));
        throw new Error(error.detail || `HTTP ${res.status}`);
      }
      
      return await res.json();
    }

    function showError(message) {
      if (tg?.showPopup) {
        tg.showPopup({ title: 'Error', message, buttons: [{ type: 'ok' }] });
      } else {
        alert(message);
      }
    }

    function showSuccess(message) {
      if (tg?.showPopup) {
        tg.showPopup({ title: 'Success', message, buttons: [{ type: 'ok' }] });
      } else {
        alert(message);
      }
    }

    // ===== NAVIGATION =====
    // Capture current view state for proper back navigation
    function captureViewState() {
      const viewData = { view: state.currentView };
      
      // Capture view-specific state
      if (state.currentView === 'ticketDetail' && state.currentTicketId) {
        viewData.ticketId = state.currentTicketId;
      }
      if (state.currentView === 'dashboard' && state.selectedGroup) {
        viewData.groupId = state.selectedGroup.group_id;
      }
      if (state.currentView === 'settings' && state.selectedGroup) {
        viewData.groupId = state.selectedGroup.group_id;
      }
      if (state.currentView === 'tickets' && state.selectedGroup) {
        viewData.groupId = state.selectedGroup.group_id;
      }
      if (state.currentView === 'rules' && state.selectedGroup) {
        viewData.groupId = state.selectedGroup.group_id;
      }
      if (state.currentView === 'analytics' && state.selectedGroup) {
        viewData.groupId = state.selectedGroup.group_id;
      }
      if (state.currentView === 'onboarding' && state.selectedGroup) {
        viewData.groupId = state.selectedGroup.group_id;
      }
      
      return viewData;
    }
    
    // Restore view state from history entry
    async function restoreViewState(historyEntry) {
      // Restore group selection if needed
      if (historyEntry.groupId && (!state.selectedGroup || state.selectedGroup.group_id !== historyEntry.groupId)) {
        const group = state.groups.find(g => g.group_id === historyEntry.groupId);
        if (group) {
          state.selectedGroup = group;
        }
      }
      
      // Restore view-specific state
      if (historyEntry.ticketId) {
        state.currentTicketId = historyEntry.ticketId;
      }
    }

    function showView(viewName, addToHistory = true, viewData = null) {
      // Hide all views
      document.querySelectorAll('[id$="View"]').forEach(view => {
        if (view.id !== 'globalHeader') {
          view.classList.add('hidden');
        }
      });

      const view = document.getElementById(viewName + 'View');
      if (view) {
        view.classList.remove('hidden');
      }

      // Handle global header visibility
      const globalHeader = document.getElementById('globalHeader');
      const headerTitle = document.getElementById('headerTitle');
      
      // Pages that should NOT show the header (main pages)
      const noHeaderPages = ['status'];
      
      if (globalHeader && headerTitle) {
        if (noHeaderPages.includes(viewName)) {
          globalHeader.classList.add('hidden');
        } else {
          globalHeader.classList.remove('hidden');
          
          // Set header title based on view
          const titles = {
            'groupSelection': 'Select Group',
            'dashboard': state.selectedGroup?.group_name || 'Group Settings',
            'whyVerification': 'Why Verification?',
            'howToUnlock': 'How to Unlock',
            'aboutSettings': 'About Settings',
            'privacyPolicy': 'Privacy Policy',
            'faq': 'FAQ',
            'settings': 'Configure Bot',
            'tickets': 'Tickets',
            'ticketDetail': state.currentTicketId ? `Ticket #${state.currentTicketId}` : 'Ticket Details',
            'analytics': 'Analytics',
            'rules': 'Rules',
            'onboarding': 'Onboarding',
            'broadcast': 'Broadcast',
            'accountDetails': 'Settings',
          };
          headerTitle.textContent = titles[viewName] || 'Mercle Bot';
        }
      }
      
      // Capture current state before changing view (for history)
      if (addToHistory && state.currentView !== viewName) {
        const currentState = captureViewState();
        state.viewHistory.push(currentState);
        // Limit history size to prevent memory issues
        if (state.viewHistory.length > 20) {
          state.viewHistory.shift();
        }
      }
      
      state.currentView = viewName;
      
      // Render specific views
      if (viewName === 'accountDetails') {
        renderAccountDetails();
      }
      if (viewName === 'dashboard') {
        renderDashboard();
      }
      
      // Call content loader functions for info pages
      const contentLoaders = {
        'whyVerification': showWhyVerification,
        'howToUnlock': showHowToUnlock,
        'aboutSettings': showAboutSettings,
        'privacyPolicy': showPrivacyPolicy,
        'faq': showFAQ,
        'accountDetails': showAccountDetails,
      };
      
      if (contentLoaders[viewName]) {
        contentLoaders[viewName]();
      }
    }

    async function goBack() {
      if (state.viewHistory.length > 0) {
        const previousEntry = state.viewHistory.pop();
        
        // Restore the state from history
        await restoreViewState(previousEntry);
        
        // Navigate to the view without adding to history
        showView(previousEntry.view, false);
        
        // If it was a ticket detail, reload it
        if (previousEntry.view === 'ticketDetail' && previousEntry.ticketId) {
          loadTicketDetail(previousEntry.ticketId);
        }
      } else {
        showView('status', false);
      }
    }

    // ===== DEMO MODE =====
    const DEMO_MODE = true; // Set to false in production
    const SHOW_LOCKED_STATE = false; // Toggle between locked/unlocked state
    
    function loadDemoData() {
      state.groups = [
        { 
          group_id: -1001234567890, 
          group_name: "Crypto Traders Hub", 
          member_count: 1523, 
          settings: { 
            verification_enabled: true, 
            verification_timeout: 300, 
            action_on_timeout: 'kick', 
            antiflood_enabled: true, 
            antiflood_limit: 10, 
            raid_mode_enabled: false 
          } 
        },
        { 
          group_id: -1001234567891, 
          group_name: "NFT Community", 
          member_count: 892, 
          settings: { 
            verification_enabled: true, 
            verification_timeout: 600, 
            action_on_timeout: 'mute', 
            antiflood_enabled: false, 
            antiflood_limit: 20, 
            raid_mode_enabled: false 
          } 
        },
        { 
          group_id: -1001234567892, 
          group_name: "DeFi Discussion", 
          member_count: 2341, 
          settings: { 
            verification_enabled: false, 
            verification_timeout: 300, 
            action_on_timeout: 'kick', 
            antiflood_enabled: true, 
            antiflood_limit: 15, 
            raid_mode_enabled: true 
          } 
        },
        { 
          group_id: -1001234567893, 
          group_name: "Web3 Developers", 
          member_count: 567, 
          settings: { 
            verification_enabled: true, 
            verification_timeout: 300, 
            action_on_timeout: 'kick', 
            antiflood_enabled: true, 
            antiflood_limit: 10, 
            raid_mode_enabled: false 
          } 
        },
      ];
      
      if (SHOW_LOCKED_STATE) {
        // Unverified user - locked state
        state.verification = {
          is_verified: false,
          verified_until: null,
          mercle_user_id: null
        };
      } else {
        // Verified user - unlocked state
        state.verification = {
          is_verified: true,
          verified_until: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(),
          mercle_user_id: "mercle_demo_user_12345"
        };
      }
      
      state.user = {
        id: 123456789,
        username: "demo_user",
        first_name: "Demo",
        last_name: "User"
      };
    }

    // ===== STATUS PAGE =====
    async function loadStatus() {
      try {
        // Check if we have initData
        if (!initData || initData.trim() === '') {
          console.warn('No initData available - loading demo mode');
          
          if (DEMO_MODE) {
            loadDemoData();
            renderStatusPage();
            return;
          }
          
          const content = document.getElementById('statusContent');
          content.innerHTML = `
            <div class="card">
              <div class="card-section">
                <div class="card-row">
                  <div class="card-icon icon-warning">‚ö†Ô∏è</div>
                  <div class="card-content">
                    <div class="card-title">Open from Telegram</div>
                    <div class="card-subtitle">This Mini App must be opened from within Telegram.</div>
                  </div>
                </div>
                <p style="color: var(--text-secondary); font-size: 13px; margin-top: 12px;">
                  Please open this app through the bot's menu button or a Mini App link in Telegram.
                </p>
              </div>
            </div>
          `;
          return;
        }

        const data = await api('/api/app/bootstrap');
        console.log('Bootstrap data received:', data);
        state.groups = data.groups || [];
        state.verification = data.verification || {};
        state.user = data.user || {};
        
        console.log('State after loading:', {
          groupCount: state.groups.length,
          isVerified: state.verification.is_verified,
          userId: state.user.id
        });
        
        renderStatusPage();
      } catch (error) {
        console.error('Failed to load status:', error);
        const content = document.getElementById('statusContent');
        content.innerHTML = `
          <div class="card">
            <div class="card-section">
              <div class="card-row">
                <div class="card-icon icon-danger">‚ùå</div>
                <div class="card-content">
                  <div class="card-title">Error Loading Data</div>
                  <div class="card-subtitle">${error.message || 'Unknown error'}</div>
                </div>
              </div>
              <p style="color: var(--text-secondary); font-size: 13px; margin-top: 12px;">
                Please try closing and reopening the Mini App. If the problem persists, contact support.
              </p>
            </div>
          </div>
          <button class="btn btn-primary" onclick="loadStatus()" style="margin-top: 16px;">
            üîÑ Retry
          </button>
        `;
      }
    }

    function renderStatusPage() {
      const content = document.getElementById('statusContent');
      const isVerified = state.verification.is_verified;
      const groupCount = state.groups.length;
      
      // Get user photo URL from Telegram WebApp
      const userPhoto = tg?.initDataUnsafe?.user?.photo_url || null;
      const userName = state.user?.first_name || state.user?.username || 'User';
      const userInitial = userName.charAt(0).toUpperCase();
      
      // Check if verification is expiring soon (less than 2 days)
      const verifiedUntil = state.verification?.verified_until;
      let isExpiringSoon = false;
      let isExpired = false;
      
      if (verifiedUntil) {
        const expiryDate = new Date(verifiedUntil);
        const now = new Date();
        const hoursRemaining = (expiryDate - now) / (1000 * 60 * 60);
        isExpiringSoon = hoursRemaining > 0 && hoursRemaining < 48; // Less than 2 days
        isExpired = hoursRemaining <= 0;
      }
      
      if (isVerified || (verifiedUntil && !isExpired)) {
        // Verified user view - Clean, intuitive design
        const mercleId = state.verification.mercle_user_id || 'N/A';
        const timeRemaining = verifiedUntil ? formatTimeRemaining(verifiedUntil) : 'N/A';
        
        // Determine status color and message
        let statusColor = '#34C759'; // Green
        let statusMessage = 'Verified';
        let expiryWarning = '';
        
        if (isExpiringSoon) {
          statusColor = '#FF9F0A'; // Orange/Warning
          statusMessage = 'Expiring Soon';
          expiryWarning = `<div style="margin-top: 12px; padding: 10px 14px; background: rgba(255, 159, 10, 0.15); border-radius: 10px; font-size: 13px; color: #FF9F0A;">
            ‚ö†Ô∏è Your verification expires in ${timeRemaining}. Please re-verify to maintain access.
          </div>`;
        }
        
        content.innerHTML = `
          <div style="display: flex; flex-direction: column; height: 100%; padding: 16px 0;">
            <!-- Top Section: User Photo + Status -->
            <div style="flex: 0 0 auto; text-align: center; padding: 16px 0 24px;">
              <!-- User Profile Photo -->
              <div style="width: 80px; height: 80px; margin: 0 auto 14px; position: relative;">
                ${userPhoto 
                  ? `<img src="${userPhoto}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid ${statusColor};" />`
                  : `<div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, ${statusColor} 0%, ${statusColor}dd 100%); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700; color: white; border: 3px solid ${statusColor};">${userInitial}</div>`
                }
                <!-- Verification badge -->
                <div style="position: absolute; bottom: -2px; right: -2px; width: 28px; height: 28px; background: ${statusColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid var(--bg);">
                  <span style="font-size: 14px; color: white;">‚úì</span>
                </div>
              </div>
              <div style="font-size: 20px; font-weight: 700; margin-bottom: 4px; color: var(--text);">${userName}</div>
              <div style="font-size: 14px; color: ${statusColor}; font-weight: 600; margin-bottom: 4px;">${statusMessage}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">
                ${isExpiringSoon ? `Expires: ${timeRemaining}` : `Valid for ${timeRemaining}`}
              </div>
              ${expiryWarning}
              ${isExpiringSoon ? `
              <button class="btn" onclick="startVerification()" style="margin-top: 12px; background: #FF9F0A; color: white; padding: 10px 20px; font-size: 14px;">
                üîÑ Re-verify Now
              </button>
              ` : ''}
            </div>

            <!-- Middle Section: Access Menu (Takes remaining space) -->
            <div style="flex: 1 1 auto; display: flex; flex-direction: column;">
              <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; padding: 0 4px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Access</div>
              
              <!-- Groups Item -->
              <div class="card" onclick="openGroupSelection()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
                <div class="card-section" style="padding: 14px 16px;">
                  <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(52, 199, 89, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                      üë•
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Groups</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">${groupCount} available ¬∑ Configure bot settings</div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                  </div>
                </div>
              </div>

              <!-- Settings Item -->
              <div class="card" onclick="showView('accountDetails')" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
                <div class="card-section" style="padding: 14px 16px;">
                  <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(142, 142, 147, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                      ‚öôÔ∏è
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Settings</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">Account ¬∑ Verification ¬∑ Data</div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                  </div>
                </div>
              </div>

              <!-- Mini Apps Item -->
              <div class="card" style="opacity: 0.5; cursor: not-allowed;">
                <div class="card-section" style="padding: 14px 16px;">
                  <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(142, 142, 147, 0.1); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                      üéÆ
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Mini Games</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">Coming soon</div>
                    </div>
                    <div style="padding: 3px 8px; background: rgba(142, 142, 147, 0.2); border-radius: 8px; font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Soon</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Section: CTA Button + Footer (Stick to bottom) -->
            <div style="margin-top: auto; padding-top: 16px; padding-bottom: 20px;">
              <button class="btn btn-primary" onclick="openGroupSelection()" style="margin-bottom: 16px; font-size: 16px; padding: 14px 24px; border-radius: 12px; box-shadow: 0 4px 16px rgba(10, 132, 255, 0.3);">
                Manage Groups (${groupCount})
              </button>

              <div style="text-align: center;">
                <a class="link" onclick="showView('privacyPolicy')" style="font-size: 12px;">Privacy Policy</a>
                <span style="color: var(--text-secondary); margin: 0 8px;">‚Ä¢</span>
                <a class="link" onclick="showView('faq')" style="font-size: 12px;">FAQ</a>
              </div>
            </div>
          </div>
        `;
      } else {
        // Unverified user view - Clean, intuitive design with proper spacing
        content.innerHTML = `
          <div style="display: flex; flex-direction: column; height: 100%; padding: 16px 0;">
            <!-- Top Section: Shield Icon + Status -->
            <div style="flex: 0 0 auto; text-align: center; padding: 24px 0 20px;">
              <div style="width: 120px; height: 120px; margin: 0 auto 18px; position: relative; display: flex; align-items: center; justify-content: center;">
                <!-- Shield background -->
                <div style="position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, #FF9500 0%, #FF9F0A 100%); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); box-shadow: 0 12px 32px rgba(255, 149, 0, 0.4);"></div>
                <!-- Checkmark -->
                <div style="position: relative; z-index: 1; font-size: 56px; color: white; font-weight: bold;">‚úì</div>
              </div>
              <div style="font-size: 24px; font-weight: 700; margin-bottom: 10px; color: var(--text);">Verification Required</div>
              <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6; padding: 0 20px;">
                Verify to manage bot settings for your groups.
              </div>
            </div>

            <!-- Middle Section: Info Cards -->
            <div style="flex: 1 1 auto; display: flex; flex-direction: column; justify-content: center; padding: 0 0 16px;">
              <div class="card" style="margin-bottom: 12px;">
                <div class="card-section" style="padding: 16px;">
                  <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(10, 132, 255, 0.15); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">
                      ‚ö°
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Quick & Secure</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">Takes less than a minute</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="card">
                <div class="card-section" style="padding: 16px;">
                  <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(52, 199, 89, 0.15); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">
                      üîì
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Full Access</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">Manage groups, settings & more</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Section: CTA Button + Footer (Stick to bottom) -->
            <div style="margin-top: auto; padding-top: 16px; padding-bottom: 20px;">
              <button class="btn btn-primary" onclick="startVerification()" style="margin-bottom: 16px; font-size: 17px; padding: 15px 32px; border-radius: 12px; box-shadow: 0 6px 20px rgba(10, 132, 255, 0.35);">
                Verify Now
              </button>

              <div style="text-align: center;">
                <a class="link" onclick="showView('privacyPolicy')" style="font-size: 12px;">Privacy Policy</a>
                <span style="color: var(--text-secondary); margin: 0 8px;">‚Ä¢</span>
                <a class="link" onclick="showView('faq')" style="font-size: 12px;">FAQ</a>
              </div>
            </div>
          </div>
        `;
      }
    }

    function renderAccountDetails() {
      const content = document.getElementById('accountDetailsContent');
      const verifiedUntil = state.verification.verified_until;
      const mercleId = state.verification.mercle_user_id || 'N/A';
      const timeRemaining = verifiedUntil ? formatTimeRemaining(verifiedUntil) : 'N/A';
      const userId = state.user.id || 'N/A';
      const username = state.user.username ? `@${state.user.username}` : 'No username';
      const firstName = state.user.first_name || 'User';
      
      content.innerHTML = `
        <div style="display: flex; flex-direction: column; height: 100%; padding: 16px 0;">
          <!-- Account Section -->
          <div style="flex: 0 0 auto; margin-bottom: 20px;">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; padding: 0 4px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Account</div>
            <div class="card">
              <div class="card-section" style="padding: 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--accent) 0%, #0066cc 100%); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(10, 132, 255, 0.25);">
                    üë§
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 17px; font-weight: 600; margin-bottom: 2px; color: var(--text);">${firstName}</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">${username}</div>
                  </div>
                </div>
              </div>
              <div class="card-section" style="padding: 14px 16px; border-top: 1px solid var(--separator);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 14px; color: var(--text-secondary);">User ID</span>
                  <span style="font-size: 14px; font-weight: 500; color: var(--text);">${userId}</span>
                </div>
              </div>
              <div class="card-section" style="padding: 14px 16px; border-top: 1px solid var(--separator);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 14px; color: var(--text-secondary);">Mercle ID</span>
                  <span style="font-size: 13px; font-weight: 500; color: var(--text); font-family: monospace; background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px;">${mercleId}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Verification Section -->
          <div style="flex: 0 0 auto; margin-bottom: 20px;">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; padding: 0 4px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Verification</div>
            <div class="card">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 14px; color: var(--text-secondary);">Status</span>
                  <span style="font-size: 14px; font-weight: 600; color: var(--success);">‚úì Verified</span>
                </div>
              </div>
              <div class="card-section" style="padding: 14px 16px; border-top: 1px solid var(--separator);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 14px; color: var(--text-secondary);">Valid for</span>
                  <span style="font-size: 14px; font-weight: 500; color: var(--text);">${timeRemaining}</span>
                </div>
              </div>
              <div class="card-section" style="padding: 14px 16px; border-top: 1px solid var(--separator);" onclick="startVerification()" style="cursor: pointer;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                  <span style="font-size: 14px; color: var(--accent);">üîÑ Re-verify Account</span>
                  <span style="font-size: 16px; color: var(--text-secondary);">‚Ä∫</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Spacer -->
          <div style="flex: 1 1 auto;"></div>

          <!-- Data Section -->
          <div style="flex: 0 0 auto;">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; padding: 0 4px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Data</div>
            <div class="card" style="border: 1px solid rgba(255, 69, 58, 0.2);">
              <div class="card-section" style="padding: 14px 16px;" onclick="confirmDeleteData()">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                  <div>
                    <div style="font-size: 14px; color: var(--danger); font-weight: 500;">üóëÔ∏è Delete My Data</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">Remove all your information</div>
                  </div>
                  <span style="font-size: 16px; color: var(--text-secondary);">‚Ä∫</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function formatTimeRemaining(verifiedUntil) {
      try {
        const expiryDate = new Date(verifiedUntil);
        const now = new Date();
        const diff = expiryDate - now;
        
        if (diff <= 0) return 'Expired';
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        
        if (days > 0) {
          return `${days}d ${hours}h remaining`;
        } else {
          return `${hours}h remaining`;
        }
      } catch (e) {
        return 'N/A';
      }
    }

    function startVerification() {
      try {
        const botUsername = state.botInfo?.username || 'mercleMerci_bot';
        const verifyLink = `https://t.me/${botUsername}?start=verify`;
        
        // Try to open the bot chat with verify command
        if (tg?.openTelegramLink) {
          tg.openTelegramLink(verifyLink);
        } else if (tg?.openLink) {
          tg.openLink(verifyLink);
        } else {
          // Fallback: just close and show message
          showError('Please open @' + botUsername + ' and send /verify');
          if (tg?.close) {
            setTimeout(() => tg.close(), 2000);
          }
        }
      } catch (error) {
        console.error('Error starting verification:', error);
        showError('Failed to start verification. Please open the bot and send /verify');
      }
    }

    function confirmDeleteData() {
      if (tg?.showConfirm) {
        tg.showConfirm(
          'Are you sure you want to delete all your data? This action cannot be undone.',
          async (confirmed) => {
            if (confirmed) {
              await deleteMyData();
            }
          }
        );
      } else {
        if (confirm('Are you sure you want to delete all your data? This action cannot be undone.')) {
          deleteMyData();
        }
      }
    }

    async function deleteMyData() {
      try {
        await api('/api/app/delete-my-data');
        showSuccess('Your data has been deleted.');
        if (tg?.close) {
          setTimeout(() => tg.close(), 1000);
        }
      } catch (error) {
        showError('Failed to delete data: ' + error.message);
      }
    }

    // ===== INFO PAGES =====
    function showWhyVerification() {
      const view = document.getElementById('whyVerificationView');
      view.innerHTML = `
        <h2>Why Verification is Needed</h2>
        
        <h3>Security & Trust</h3>
        <p>Verification ensures that only real, authenticated users can access group management features. This protects your communities from unauthorized access and malicious actors.</p>
        
        <h3>Spam Prevention</h3>
        <p>By requiring biometric verification through Mercle SDK, we prevent bots, spam accounts, and automated attacks from infiltrating your groups.</p>
        
        <h3>Privacy Protection</h3>
        <p>Verification helps us maintain a secure environment where your personal data and group settings are protected from unauthorized modifications.</p>
        
        <h3>Compliance</h3>
        <p>Our verification system ensures compliance with Telegram's terms of service and data protection regulations.</p>
      `;
    }

    function showHowToUnlock() {
      const view = document.getElementById('howToUnlockView');
      view.innerHTML = `
        <h2>How to Unlock Access</h2>
        
        <h3>Step 1: Start Verification</h3>
        <p>Click the "Verify My Account" button on the main page. This will open a chat with the bot.</p>
        
        <h3>Step 2: Complete Mercle SDK</h3>
        <p>Follow the instructions in the bot chat to complete biometric verification using Mercle SDK. This process is secure and takes only a few minutes.</p>
        
        <h3>Step 3: Access Unlocked</h3>
        <p>Once verified, you'll have full access to:</p>
        <ul>
          <li>Group management settings</li>
          <li>Admin dashboard and analytics</li>
          <li>Ticket system</li>
          <li>Rules and moderation tools</li>
          <li>All Mini App features</li>
        </ul>
        
        <h3>Verification Duration</h3>
        <p>Your verification is valid for 7 days. After that, you'll need to verify again to maintain access.</p>
      `;
    }

    function showAboutSettings() {
      const view = document.getElementById('aboutSettingsView');
      view.innerHTML = `
        <h2>About Settings</h2>
        
        <h3>What You'll Get Access To</h3>
        <p>Once verified, you'll be able to manage comprehensive settings for your groups:</p>
        
        <h3>Verification Settings</h3>
        <ul>
          <li>Enable/disable verification for new members</li>
          <li>Set verification timeout duration</li>
          <li>Choose action on timeout (kick or mute)</li>
        </ul>
        
        <h3>Anti-Flood Protection</h3>
        <ul>
          <li>Set message limits per minute</li>
          <li>Configure automatic actions for spammers</li>
          <li>Whitelist trusted users</li>
        </ul>
        
        <h3>Raid Mode</h3>
        <ul>
          <li>Emergency protection during raids</li>
          <li>Temporary restrictions on new members</li>
          <li>Enhanced moderation controls</li>
        </ul>
        
        <h3>Rules & Moderation</h3>
        <ul>
          <li>Create custom auto-moderation rules</li>
          <li>Set up keyword filters</li>
          <li>Configure automated actions</li>
        </ul>
        
        <h3>Onboarding</h3>
        <ul>
          <li>Welcome messages for new members</li>
          <li>Automated sequences</li>
          <li>Custom delays and formatting</li>
        </ul>
      `;
    }

    function showPrivacyPolicy() {
      const view = document.getElementById('privacyPolicyView');
      view.innerHTML = `
        <h2>Privacy Policy</h2>
        
        <h3>Data Collection</h3>
        <p>We collect only the minimum data necessary to provide our services:</p>
        <ul>
          <li>Telegram user ID and username</li>
          <li>Mercle verification ID (after verification)</li>
          <li>Group membership information</li>
          <li>Bot interaction logs</li>
        </ul>
        
        <h3>Data Usage</h3>
        <p>Your data is used exclusively for:</p>
        <ul>
          <li>Verifying your identity</li>
          <li>Managing group access and permissions</li>
          <li>Providing bot functionality</li>
          <li>Improving our services</li>
        </ul>
        
        <h3>Data Storage</h3>
        <p>All data is stored securely in encrypted databases. We implement industry-standard security measures to protect your information.</p>
        
        <h3>Data Sharing</h3>
        <p>We never sell or share your personal data with third parties. Verification is handled through Mercle SDK's secure infrastructure.</p>
        
        <h3>Your Rights</h3>
        <p>You have the right to:</p>
        <ul>
          <li>Access your data at any time</li>
          <li>Request data deletion (via "Delete My Data" button)</li>
          <li>Opt-out of data collection (by stopping bot usage)</li>
        </ul>
        
        <h3>Data Retention</h3>
        <p>Verification data expires after 7 days. Inactive accounts may be automatically purged after 90 days of inactivity.</p>
        
        <h3>Contact</h3>
        <p>For privacy concerns or data requests, contact us through the bot's support ticket system.</p>
      `;
    }

    function showFAQ() {
      const view = document.getElementById('faqView');
      view.innerHTML = `
        <h2>Frequently Asked Questions</h2>
        
        <h3>How long does verification take?</h3>
        <p>The verification process typically takes 2-3 minutes. You'll need to complete biometric verification through Mercle SDK.</p>
        
        <h3>How long is verification valid?</h3>
        <p>Verification is valid for 7 days. After that, you'll need to verify again to maintain access to admin features.</p>
        
        <h3>What if verification fails?</h3>
        <p>If verification fails, you can try again immediately. Make sure you're following the instructions carefully and have a stable internet connection.</p>
        
        <h3>Can I use the bot without verification?</h3>
        <p>Basic bot commands work without verification, but admin features, group management, and the Mini App require verification.</p>
        
        <h3>Is my biometric data stored?</h3>
        <p>No. Biometric verification is handled by Mercle SDK. We only receive a verification confirmation, not your actual biometric data.</p>
        
        <h3>What happens if I delete my data?</h3>
        <p>All your data will be permanently removed from our systems, including verification status, group memberships, and settings. This action cannot be undone.</p>
        
        <h3>Can I manage multiple groups?</h3>
        <p>Yes! Once verified, you can manage all groups where you have admin permissions.</p>
        
        <h3>What are the bot's permissions?</h3>
        <p>The bot needs admin permissions to manage members, delete messages, and restrict users. You can configure specific permissions in group settings.</p>
        
        <h3>How do I report a bug?</h3>
        <p>Use the ticket system in the bot to report bugs or issues. Our team will respond as soon as possible.</p>
        
        <h3>Is the bot free?</h3>
        <p>Yes, the bot is completely free to use for all features.</p>
      `;
    }

    function showAccountDetails() {
      const content = document.getElementById('accountDetailsContent');
      const verifiedUntil = state.verification?.verified_until;
      const mercleId = state.verification?.mercle_user_id || 'N/A';
      const timeRemaining = verifiedUntil ? formatTimeRemaining(verifiedUntil) : 'N/A';
      const isVerified = state.verification?.is_verified;
      
      // Get user photo URL from Telegram WebApp
      const userPhoto = tg?.initDataUnsafe?.user?.photo_url || null;
      const userName = state.user?.first_name || state.user?.username || 'User';
      const userInitial = userName.charAt(0).toUpperCase();
      
      // Check expiry status
      let isExpiringSoon = false;
      let isExpired = false;
      let statusColor = '#34C759'; // Green
      let statusText = 'Verified';
      
      if (verifiedUntil) {
        const expiryDate = new Date(verifiedUntil);
        const now = new Date();
        const hoursRemaining = (expiryDate - now) / (1000 * 60 * 60);
        isExpiringSoon = hoursRemaining > 0 && hoursRemaining < 48;
        isExpired = hoursRemaining <= 0;
        
        if (isExpired) {
          statusColor = '#FF3B30'; // Red
          statusText = 'Expired';
        } else if (isExpiringSoon) {
          statusColor = '#FF9F0A'; // Orange
          statusText = 'Expiring Soon';
        }
      }
      
      if (!isVerified && !verifiedUntil) {
        statusColor = '#FF3B30';
        statusText = 'Not Verified';
      }
      
      content.innerHTML = `
        <div style="padding: 16px 0;">
          <!-- User Profile Header -->
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="width: 80px; height: 80px; margin: 0 auto 12px; position: relative;">
              ${userPhoto 
                ? `<img src="${userPhoto}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid ${statusColor};" />`
                : `<div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700; color: white; border: 3px solid ${statusColor};">${userInitial}</div>`
              }
              ${isVerified || verifiedUntil ? `
              <div style="position: absolute; bottom: -2px; right: -2px; width: 24px; height: 24px; background: ${statusColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg);">
                <span style="font-size: 12px; color: white;">${isExpired ? '!' : '‚úì'}</span>
              </div>
              ` : ''}
            </div>
            <div style="font-size: 18px; font-weight: 700; color: var(--text);">${userName}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">@${state.user?.username || 'N/A'}</div>
          </div>
          
          <div class="card" style="margin-bottom: 16px;">
            <div class="card-section">
              <div class="card-row">
                <div class="card-content">
                  <div class="card-title">User ID</div>
                  <div class="card-subtitle">${state.user?.id || 'N/A'}</div>
                </div>
              </div>
              
              <div class="card-row">
                <div class="card-content">
                  <div class="card-title">Verification Status</div>
                  <div class="card-subtitle" style="color: ${statusColor}; font-weight: 600;">
                    ${statusText}
                  </div>
                </div>
                ${(isExpiringSoon || isExpired) ? `
                <button class="btn" onclick="startVerification()" style="background: ${statusColor}; color: white; padding: 6px 12px; font-size: 12px; margin-left: auto;">
                  Re-verify
                </button>
                ` : ''}
              </div>
              
              ${(isVerified || verifiedUntil) ? `
              <div class="card-row">
                <div class="card-content">
                  <div class="card-title">Mercle ID</div>
                  <div class="card-subtitle">${mercleId}</div>
                </div>
              </div>
              
              <div class="card-row">
                <div class="card-content">
                  <div class="card-title">Verification ${isExpired ? 'Expired' : 'Expires'}</div>
                  <div class="card-subtitle" style="color: ${isExpired ? '#FF3B30' : (isExpiringSoon ? '#FF9F0A' : 'var(--text-secondary)')};">
                    ${isExpired ? 'Please re-verify' : timeRemaining}
                  </div>
                </div>
              </div>
              ` : `
              <div class="card-row">
                <div class="card-content">
                  <div class="card-title" style="color: var(--text-secondary);">
                    Verify your account to access group settings
                  </div>
                </div>
                <button class="btn btn-primary" onclick="startVerification()" style="padding: 6px 12px; font-size: 12px; margin-left: auto;">
                  Verify Now
                </button>
              </div>
              `}
            </div>
          </div>
          
          ${(isExpiringSoon || isExpired) ? `
          <div style="padding: 12px 16px; background: rgba(${isExpired ? '255, 59, 48' : '255, 159, 10'}, 0.15); border-radius: 12px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 20px;">${isExpired ? '‚ö†Ô∏è' : '‚è∞'}</span>
              <div>
                <div style="font-size: 14px; font-weight: 600; color: ${statusColor};">
                  ${isExpired ? 'Verification Expired' : 'Verification Expiring Soon'}
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  ${isExpired ? 'Re-verify to maintain full access to group features.' : `Expires in ${timeRemaining}. Re-verify to avoid interruption.`}
                </div>
              </div>
            </div>
            <button class="btn" onclick="startVerification()" style="width: 100%; margin-top: 12px; background: ${statusColor}; color: white;">
              üîÑ Re-verify Now
            </button>
          </div>
          ` : ''}
          
          <div style="margin-top: 24px;">
            <button class="btn btn-danger" onclick="confirmDeleteData()">
              üóëÔ∏è Delete My Data
            </button>
          </div>
          
          <div style="text-align: center; margin-top: 16px;">
            <a class="link" onclick="showView('privacyPolicy')" style="font-size: 13px;">Privacy Policy</a>
            <span style="color: var(--text-secondary); margin: 0 8px;">‚Ä¢</span>
            <a class="link" onclick="showView('faq')" style="font-size: 13px;">FAQ</a>
          </div>
        </div>
      `;
    }

    // ===== GROUP SELECTION =====
    function openGroupSelection() {
      showView('groupSelection');
      renderGroups();
    }

    function renderGroups() {
      const list = document.getElementById('groupList');
      const noGroupsState = document.getElementById('noGroupsState');
      
      if (state.groups.length === 0) {
        list.innerHTML = '';
        noGroupsState.classList.remove('hidden');
        return;
      }

      noGroupsState.classList.add('hidden');
      
      list.innerHTML = state.groups.map(group => {
        const initial = (group.group_name || 'G')[0].toUpperCase();
        const memberCount = group.member_count || 0;
        
        return `
          <div class="group-item" onclick="selectGroup(${group.group_id})">
            <div class="group-avatar">${initial}</div>
            <div class="group-info">
              <div class="group-name">${group.group_name || `Group ${group.group_id}`}</div>
              <div class="group-stats">üë• ${memberCount.toLocaleString()} members</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterGroups() {
      const query = document.getElementById('groupSearch').value.toLowerCase().trim();
      const items = document.querySelectorAll('.group-item');
      let visibleCount = 0;
      
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const isVisible = text.includes(query);
        item.style.display = isVisible ? 'flex' : 'none';
        if (isVisible) visibleCount++;
      });
      
      // Show/hide empty state
      let emptyState = document.getElementById('searchEmptyState');
      if (!emptyState) {
        // Create empty state element if it doesn't exist
        const list = document.getElementById('groupList');
        emptyState = document.createElement('div');
        emptyState.id = 'searchEmptyState';
        emptyState.className = 'hidden';
        emptyState.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <div style="font-size: 48px; margin-bottom: 12px;">üîç</div>
            <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">No groups found</div>
            <div style="font-size: 14px; margin-bottom: 16px;">Try a different search term</div>
            <button onclick="clearGroupSearch()" class="btn btn-secondary" style="font-size: 14px;">
              Clear Search
            </button>
          </div>
        `;
        list.parentNode.insertBefore(emptyState, list.nextSibling);
      }
      
      if (query && visibleCount === 0) {
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
      }
    }
    
    function clearGroupSearch() {
      const searchInput = document.getElementById('groupSearch');
      if (searchInput) {
        searchInput.value = '';
        filterGroups();
      }
    }

    function selectGroup(groupId) {
      state.selectedGroup = state.groups.find(g => g.group_id === groupId);
      showView('dashboard');
      renderDashboard();
    }

    // ===== DASHBOARD =====
    function renderDashboard() {
      if (!state.selectedGroup) return;
      
      const groupName = state.selectedGroup.group_name || `Group ${state.selectedGroup.group_id}`;
      const memberCount = state.selectedGroup.member_count || 0;
      const firstLetter = groupName.charAt(0).toUpperCase();
      const isVerified = state.selectedGroup.settings?.verification_enabled;

      const content = document.getElementById('dashboardContent');
      content.innerHTML = `
        <div style="display: flex; flex-direction: column; height: 100%; padding: 16px;">
          <!-- Group Header -->
          <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--separator);">
            <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, #5856D6 0%, #AF52DE 100%); display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 700; color: white; flex-shrink: 0;">
              ${firstLetter}
            </div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">
                <span style="font-size: 18px; font-weight: 700; color: var(--text);">${groupName}</span>
                ${isVerified ? '<span style="color: var(--accent);">‚úì</span>' : ''}
              </div>
              <div style="font-size: 13px; color: var(--text-secondary);">${memberCount.toLocaleString()} members</div>
            </div>
          </div>

          <!-- Settings Section -->
          <div style="flex: 1 1 auto;">
            <div style="font-size: 18px; font-weight: 700; margin-bottom: 14px; color: var(--text);">Settings</div>
            
            <!-- Configure Bot -->
            <div class="card" onclick="loadSettings()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(142, 142, 147, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    ‚öôÔ∏è
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Configure bot</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Admin</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>

            <!-- Tickets -->
            <div class="card" onclick="loadTickets()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(255, 204, 0, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    üé´
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Tickets</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Support</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>

            <!-- Analytics -->
            <div class="card" onclick="loadAnalytics()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(52, 199, 89, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    üìä
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Analytics</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">View stats</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>

            <!-- Rules -->
            <div class="card" onclick="loadRules()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(10, 132, 255, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    üìã
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Rules</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Auto-moderation</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>

            <!-- Onboarding -->
            <div class="card" onclick="loadOnboarding()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(255, 149, 0, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    üëã
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Onboarding</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Welcome flow</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>
            
            <!-- Broadcast -->
            <div class="card" onclick="loadBroadcast()" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
              <div class="card-section" style="padding: 14px 16px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 42px; height: 42px; border-radius: 10px; background: rgba(88, 86, 214, 0.15); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0;">
                    üì¢
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Broadcast</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Send announcements</div>
                  </div>
                  <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ===== SETTINGS =====
    async function loadSettings() {
      if (!state.selectedGroup) return;
      showView('settings');
      const view = document.getElementById('settingsView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';
      
      try {
        const settings = state.selectedGroup.settings || {};
        
        // Raid mode status
        const raidActive = settings.raid_mode_enabled;
        const raidRemaining = settings.raid_mode_remaining_seconds || 0;
        const raidMins = Math.ceil(raidRemaining / 60);
        
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üîê Verification Settings</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Configure how new members are verified.</p>
            
            <div class="toggle-row">
              <span>Verification Required</span>
              <div class="toggle ${settings.verification_enabled ? 'on' : ''}" data-setting="verification_enabled" onclick="toggleSetting('verification_enabled')">
                <div class="toggle-knob"></div>
              </div>
            </div>
            
            <div class="form-group" id="verificationSettingsGroup" style="display: ${settings.verification_enabled ? 'block' : 'none'};">
              <label class="form-label">Verification Timeout</label>
              <select class="form-input" id="verificationTimeout">
                <option value="60" ${settings.verification_timeout == 60 ? 'selected' : ''}>1 minute</option>
                <option value="180" ${settings.verification_timeout == 180 ? 'selected' : ''}>3 minutes</option>
                <option value="300" ${settings.verification_timeout == 300 || !settings.verification_timeout ? 'selected' : ''}>5 minutes</option>
                <option value="600" ${settings.verification_timeout == 600 ? 'selected' : ''}>10 minutes</option>
                <option value="1800" ${settings.verification_timeout == 1800 ? 'selected' : ''}>30 minutes</option>
              </select>
              <small style="color: var(--text-secondary);">Time users have to verify before action is taken</small>
              
              <label class="form-label" style="margin-top: 12px;">Action on Timeout</label>
              <select class="form-input" id="actionOnTimeout">
                <option value="mute" ${settings.action_on_timeout !== 'kick' ? 'selected' : ''}>Mute (restrict messaging)</option>
                <option value="kick" ${settings.action_on_timeout === 'kick' ? 'selected' : ''}>Kick from group</option>
              </select>
            </div>
          </div>
          
          <div class="detail-card" style="margin-top: 16px;">
            <div class="detail-title">üåä Anti-Flood Protection</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Prevent spam by limiting message rate.</p>
            
            <div class="toggle-row">
              <span>Enable Anti-Flood</span>
              <div class="toggle ${settings.antiflood_enabled ? 'on' : ''}" data-setting="antiflood_enabled" onclick="toggleSetting('antiflood_enabled')">
                <div class="toggle-knob"></div>
              </div>
            </div>
            
            <div id="antifloodSettingsGroup" style="display: ${settings.antiflood_enabled ? 'block' : 'none'};">
              <div class="form-group">
                <label class="form-label">Message Limit (per minute)</label>
                <input type="number" class="form-input" id="antifloodLimit" value="${settings.antiflood_limit || ''}" placeholder="e.g., 10" min="3" max="100" />
                <small style="color: var(--text-secondary);">Messages allowed per minute before action</small>
              </div>
              
              <div class="form-group">
                <label class="form-label">Action When Flooding</label>
                <select class="form-input" id="antifloodAction">
                  <option value="mute" ${settings.antiflood_action === 'mute' || !settings.antiflood_action ? 'selected' : ''}>Mute user</option>
                  <option value="warn" ${settings.antiflood_action === 'warn' ? 'selected' : ''}>Warn user</option>
                  <option value="kick" ${settings.antiflood_action === 'kick' ? 'selected' : ''}>Kick user</option>
                  <option value="ban" ${settings.antiflood_action === 'ban' ? 'selected' : ''}>Ban user</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Mute Duration</label>
                <select class="form-input" id="antifloodMuteSeconds">
                  <option value="60" ${settings.antiflood_mute_seconds == 60 ? 'selected' : ''}>1 minute</option>
                  <option value="300" ${settings.antiflood_mute_seconds == 300 || !settings.antiflood_mute_seconds ? 'selected' : ''}>5 minutes</option>
                  <option value="600" ${settings.antiflood_mute_seconds == 600 ? 'selected' : ''}>10 minutes</option>
                  <option value="1800" ${settings.antiflood_mute_seconds == 1800 ? 'selected' : ''}>30 minutes</option>
                  <option value="3600" ${settings.antiflood_mute_seconds == 3600 ? 'selected' : ''}>1 hour</option>
                </select>
              </div>
              
              <div class="toggle-row">
                <span>Delete Flood Messages</span>
                <div class="toggle ${settings.antiflood_delete_messages !== false ? 'on' : ''}" data-setting="antiflood_delete_messages" onclick="toggleSetting('antiflood_delete_messages')">
                  <div class="toggle-knob"></div>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">Warnings Before Action</label>
                <select class="form-input" id="antifloodWarnThreshold">
                  <option value="0" ${!settings.antiflood_warn_threshold ? 'selected' : ''}>No warnings (immediate action)</option>
                  <option value="1" ${settings.antiflood_warn_threshold == 1 ? 'selected' : ''}>1 warning</option>
                  <option value="2" ${settings.antiflood_warn_threshold == 2 ? 'selected' : ''}>2 warnings</option>
                  <option value="3" ${settings.antiflood_warn_threshold == 3 ? 'selected' : ''}>3 warnings</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="detail-card" style="margin-top: 16px;">
            <div class="detail-title">üö® Raid Mode</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Emergency lockdown - blocks all new joins temporarily.</p>
            
            ${raidActive ? `
              <div style="background: rgba(255, 59, 48, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="color: var(--danger); font-weight: 600;">‚ö†Ô∏è Raid Mode Active</div>
                <div style="color: var(--text-secondary); font-size: 13px; margin-top: 4px;">
                  ${raidMins} minute(s) remaining
                </div>
              </div>
            ` : ''}
            
            <div class="toggle-row">
              <span>${raidActive ? 'Raid Mode (Active)' : 'Enable Raid Mode'}</span>
              <div class="toggle ${raidActive ? 'on' : ''}" data-setting="raid_mode_enabled" onclick="toggleSetting('raid_mode_enabled')" style="${raidActive ? 'background: var(--danger);' : ''}">
                <div class="toggle-knob"></div>
              </div>
            </div>
            
            <div id="raidModeSettingsGroup" style="display: ${!raidActive ? 'block' : 'none'};">
              <div class="form-group">
                <label class="form-label">Duration</label>
                <select class="form-input" id="raidModeDuration">
                  <option value="15">15 minutes</option>
                  <option value="30" selected>30 minutes</option>
                  <option value="60">1 hour</option>
                  <option value="120">2 hours</option>
                  <option value="360">6 hours</option>
                  <option value="720">12 hours</option>
                  <option value="1440">24 hours</option>
                </select>
                <small style="color: var(--text-secondary);">Raid mode will auto-disable after this time</small>
              </div>
            </div>
          </div>
          
          <div class="detail-card" style="margin-top: 16px;">
            <div class="detail-title">üîí Content Locks</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Restrict what members can post.</p>
            
            <div class="toggle-row">
              <span>Lock Links</span>
              <div class="toggle ${settings.lock_links ? 'on' : ''}" data-setting="lock_links" onclick="toggleSetting('lock_links')">
                <div class="toggle-knob"></div>
              </div>
            </div>
            <small style="color: var(--text-secondary); display: block; margin: -8px 0 12px 0;">Delete messages containing URLs</small>
            
            <div class="toggle-row">
              <span>Lock Media</span>
              <div class="toggle ${settings.lock_media ? 'on' : ''}" data-setting="lock_media" onclick="toggleSetting('lock_media')">
                <div class="toggle-knob"></div>
              </div>
            </div>
            <small style="color: var(--text-secondary); display: block; margin: -8px 0 12px 0;">Delete photos, videos, documents, etc.</small>
          </div>
          
          <div class="detail-card" style="margin-top: 16px;">
            <div class="detail-title">üìã Mod Logs</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Send admin action logs to a channel or group.</p>
            
            <div class="toggle-row">
              <span>Enable Logs</span>
              <div class="toggle ${settings.logs_enabled ? 'on' : ''}" data-setting="logs_enabled" onclick="toggleSetting('logs_enabled')">
                <div class="toggle-knob"></div>
              </div>
            </div>
            
            <div id="logsSettingsGroup" style="display: ${settings.logs_enabled ? 'block' : 'none'};">
              <div class="form-group">
                <label class="form-label">Log Channel/Group ID</label>
                <input type="text" class="form-input" id="logsChannelId" value="${settings.logs_chat_id || ''}" placeholder="e.g., -1001234567890" />
                <small style="color: var(--text-secondary);">Enter the chat ID where logs should be sent. Bot must be admin there.</small>
              </div>
              
              <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="testLogs()">üîî Test Logs</button>
            </div>
          </div>
          
          <div class="detail-card" style="margin-top: 16px;">
            <div class="detail-title">üîá Silent Mode</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Suppress bot notification messages.</p>
            
            <div class="toggle-row">
              <span>Silent Automations</span>
              <div class="toggle ${settings.silent_automations ? 'on' : ''}" data-setting="silent_automations" onclick="toggleSetting('silent_automations')">
                <div class="toggle-knob"></div>
              </div>
            </div>
            <small style="color: var(--text-secondary); display: block; margin: -8px 0 12px 0;">Don't send public messages for automated actions (mutes, warns, etc.)</small>
          </div>
          
          <div id="settingsSaveBar" style="position: sticky; bottom: 0; background: var(--bg); padding: 16px 0; margin-top: 16px; border-top: 1px solid var(--separator);">
            <button id="saveSettingsBtn" class="btn btn-primary" style="width: 100%;" onclick="saveSettings()">
              <span id="saveSettingsBtnText">Save All Settings</span>
            </button>
          </div>
        `;
      } catch (error) {
        view.innerHTML = `<div style="padding: 20px; color: var(--danger);">Error: ${error.message}</div>`;
      }
    }

    async function saveSettings() {
      if (!state.selectedGroup) return;
      
      const btn = document.getElementById('saveSettingsBtn');
      const btnText = document.getElementById('saveSettingsBtnText');
      
      // Show saving state
      if (btn) btn.disabled = true;
      if (btnText) btnText.textContent = 'Saving...';
      
      try {
        const groupId = state.selectedGroup.group_id;
        const settings = state.selectedGroup.settings || {};
        
        // Get toggle states by data-setting attribute
        const verificationEnabled = document.querySelector('[data-setting="verification_enabled"]')?.classList.contains('on') ?? settings.verification_enabled;
        const antifloodEnabled = document.querySelector('[data-setting="antiflood_enabled"]')?.classList.contains('on') ?? settings.antiflood_enabled;
        const antifloodDeleteMessages = document.querySelector('[data-setting="antiflood_delete_messages"]')?.classList.contains('on') ?? true;
        const raidModeEnabled = document.querySelector('[data-setting="raid_mode_enabled"]')?.classList.contains('on') ?? settings.raid_mode_enabled;
        const lockLinks = document.querySelector('[data-setting="lock_links"]')?.classList.contains('on') ?? settings.lock_links;
        const lockMedia = document.querySelector('[data-setting="lock_media"]')?.classList.contains('on') ?? settings.lock_media;
        const logsEnabled = document.querySelector('[data-setting="logs_enabled"]')?.classList.contains('on') ?? settings.logs_enabled;
        const silentAutomations = document.querySelector('[data-setting="silent_automations"]')?.classList.contains('on') ?? settings.silent_automations;
        
        // Get form values
        const timeout = parseInt(document.getElementById('verificationTimeout')?.value) || 300;
        const actionOnTimeout = document.getElementById('actionOnTimeout')?.value || 'mute';
        const antifloodLimit = parseInt(document.getElementById('antifloodLimit')?.value) || 10;
        const antifloodAction = document.getElementById('antifloodAction')?.value || 'mute';
        const antifloodMuteSeconds = parseInt(document.getElementById('antifloodMuteSeconds')?.value) || 300;
        const antifloodWarnThreshold = parseInt(document.getElementById('antifloodWarnThreshold')?.value) || 0;
        const raidModeDuration = parseInt(document.getElementById('raidModeDuration')?.value) || 30;
        const logsChannelId = document.getElementById('logsChannelId')?.value?.trim() || null;
        
        // Call API to save settings
        await api(`/api/app/group/${groupId}/settings`, {
          verification_enabled: verificationEnabled,
          verification_timeout: timeout,
          action_on_timeout: actionOnTimeout,
          antiflood_enabled: antifloodEnabled,
          antiflood_limit: antifloodLimit,
          antiflood_action: antifloodAction,
          antiflood_mute_seconds: antifloodMuteSeconds,
          antiflood_delete_messages: antifloodDeleteMessages,
          antiflood_warn_threshold: antifloodWarnThreshold,
          raid_mode_enabled: raidModeEnabled,
          raid_mode_duration_minutes: raidModeDuration,
          lock_links: lockLinks,
          lock_media: lockMedia,
          logs_mode: logsEnabled ? 'group' : 'off',
          silent_automations: silentAutomations
        });
        
        // If logs enabled, set the channel ID separately
        if (logsEnabled && logsChannelId) {
          try {
            await api(`/api/app/group/${groupId}/logs/channel`, {
              chat_id: parseInt(logsChannelId)
            });
          } catch (e) {
            console.warn('Failed to set logs channel:', e);
          }
        }
        
        // Update local state
        state.selectedGroup.settings = {
          ...settings,
          verification_enabled: verificationEnabled,
          verification_timeout: timeout,
          action_on_timeout: actionOnTimeout,
          antiflood_enabled: antifloodEnabled,
          antiflood_limit: antifloodLimit,
          antiflood_action: antifloodAction,
          antiflood_mute_seconds: antifloodMuteSeconds,
          antiflood_delete_messages: antifloodDeleteMessages,
          antiflood_warn_threshold: antifloodWarnThreshold,
          raid_mode_enabled: raidModeEnabled,
          lock_links: lockLinks,
          lock_media: lockMedia,
          logs_enabled: logsEnabled,
          logs_chat_id: logsChannelId ? parseInt(logsChannelId) : null,
          silent_automations: silentAutomations
        };
        
        // Show success state
        if (btnText) btnText.textContent = '‚úì Saved!';
        setTimeout(() => {
          if (btnText) btnText.textContent = 'Save All Settings';
          if (btn) btn.disabled = false;
        }, 2000);
        
        showSuccess('Settings saved successfully');
      } catch (error) {
        console.error('Failed to save settings:', error);
        showError('Failed to save settings: ' + error.message);
        
        // Reset button state on error
        if (btnText) btnText.textContent = 'Save All Settings';
        if (btn) btn.disabled = false;
      }
    }
    
    async function testLogs() {
      if (!state.selectedGroup) return;
      
      try {
        const groupId = state.selectedGroup.group_id;
        await api(`/api/app/group/${groupId}/logs/test`);
        showSuccess('Test log sent! Check your logs channel.');
      } catch (error) {
        console.error('Failed to test logs:', error);
        showError('Failed to test logs: ' + error.message);
      }
    }

    function toggleSetting(key) {
      // Toggle the visual state
      const toggle = event.target.closest('.toggle');
      if (toggle) {
        toggle.classList.toggle('on');
        const isOn = toggle.classList.contains('on');
        
        // Show/hide related input fields
        if (key === 'verification_enabled') {
          const group = document.getElementById('verificationSettingsGroup');
          if (group) group.style.display = isOn ? 'block' : 'none';
        }
        if (key === 'antiflood_enabled') {
          const group = document.getElementById('antifloodSettingsGroup');
          if (group) group.style.display = isOn ? 'block' : 'none';
        }
        if (key === 'raid_mode_enabled') {
          const group = document.getElementById('raidModeSettingsGroup');
          if (group) group.style.display = isOn ? 'none' : 'block'; // Hide when enabling (show duration picker before)
        }
        if (key === 'logs_enabled') {
          const group = document.getElementById('logsSettingsGroup');
          if (group) group.style.display = isOn ? 'block' : 'none';
        }
      }
    }

    // ===== TICKETS =====
    let currentTicketFilter = 'open';
    
    async function loadTickets() {
      if (!state.selectedGroup) return;
      showView('tickets');
      const view = document.getElementById('ticketsView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading tickets...</div>';
      
      try {
        const groupId = state.selectedGroup.group_id;
        const data = await api(`/api/app/group/${groupId}/tickets`);
        const openTickets = data.open_tickets || [];
        const closedTickets = data.closed_tickets || [];
        const totalOpen = data.total_open || 0;
        const totalClosed = data.total_closed || 0;
        
        const tickets = currentTicketFilter === 'open' ? openTickets : closedTickets;
        
        const ticketHtml = tickets.length === 0 
          ? `<div style="text-align: center; color: var(--text-secondary); padding: 30px 0;">
               No ${currentTicketFilter} tickets
             </div>`
          : tickets.map(t => `
              <div class="card" onclick="loadTicketDetail(${t.id})" style="cursor: pointer; margin-bottom: 10px; transition: transform 0.15s;" onmouseover="this.style.transform='translateY(-1px)';" onmouseout="this.style.transform='';">
                <div class="card-section" style="padding: 14px 16px;">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 10px; height: 10px; border-radius: 50%; background: ${t.status === 'open' ? 'var(--success)' : 'var(--text-secondary)'}; flex-shrink: 0;"></div>
                    <div style="flex: 1; min-width: 0;">
                      <div style="font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        #${t.id} - ${escapeHtml(t.subject || 'No subject')}
                      </div>
                      <div style="font-size: 13px; color: var(--text-secondary);">
                        User: ${t.user_id} ‚Ä¢ ${t.created_at ? new Date(t.created_at).toLocaleDateString() : 'N/A'}
                      </div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-secondary);">‚Ä∫</div>
                  </div>
                </div>
              </div>
            `).join('');
        
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üé´ Support Tickets</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Manage user support requests.</p>
            
            <!-- Filter Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
              <button class="btn ${currentTicketFilter === 'open' ? 'btn-primary' : 'btn-secondary'}" 
                      onclick="filterTickets('open')" style="flex: 1;">
                Open (${totalOpen})
              </button>
              <button class="btn ${currentTicketFilter === 'closed' ? 'btn-primary' : 'btn-secondary'}" 
                      onclick="filterTickets('closed')" style="flex: 1;">
                Closed (${totalClosed})
              </button>
            </div>
            
            ${ticketHtml}
          </div>
        `;
      } catch (error) {
        console.error('Failed to load tickets:', error);
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üé´ Support Tickets</div>
            <p style="color: var(--text-secondary);">Manage user support requests.</p>
            <div style="margin-top: 20px; text-align: center; color: var(--danger);">
              Failed to load tickets: ${error.message}
            </div>
          </div>
        `;
      }
    }
    
    function filterTickets(filter) {
      currentTicketFilter = filter;
      loadTickets();
    }
    
    async function loadTicketDetail(ticketId) {
      if (!state.selectedGroup) return;
      
      // Store current ticket ID for navigation history
      state.currentTicketId = ticketId;
      
      showView('ticketDetail');
      const view = document.getElementById('ticketDetailView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading ticket...</div>';
      
      try {
        const groupId = state.selectedGroup.group_id;
        const data = await api(`/api/app/group/${groupId}/tickets/${ticketId}`);
        const ticket = data.ticket;
        const messages = data.messages || [];
        
        const isOpen = ticket.status === 'open';
        
        // Build conversation HTML
        const conversationHtml = messages.length === 0
          ? `<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No messages yet</div>`
          : messages.map(m => {
              const isUser = m.sender_type === 'user';
              const isSystem = m.sender_type === 'system';
              const time = m.created_at ? new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
              const date = m.created_at ? new Date(m.created_at).toLocaleDateString() : '';
              
              if (isSystem) {
                return `
                  <div style="text-align: center; margin: 12px 0;">
                    <span style="background: var(--bg-tertiary); color: var(--text-secondary); padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                      ${escapeHtml(m.content || '')}
                    </span>
                  </div>
                `;
              }
              
              return `
                <div style="display: flex; flex-direction: column; align-items: ${isUser ? 'flex-start' : 'flex-end'}; margin: 8px 0;">
                  <div style="max-width: 85%; padding: 10px 14px; border-radius: 16px; background: ${isUser ? 'var(--bg-tertiary)' : 'var(--accent)'}; color: ${isUser ? 'var(--text)' : 'var(--accent-text)'};">
                    <div style="font-size: 14px; line-height: 1.4; word-wrap: break-word;">${escapeHtml(m.content || '')}</div>
                  </div>
                  <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; padding: 0 4px;">
                    ${isUser ? 'User' : (m.sender_name || 'Staff')} ‚Ä¢ ${time}
                  </div>
                </div>
              `;
            }).join('');
        
        view.innerHTML = `
          <div class="detail-card">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
              <div>
                <div class="detail-title" style="margin-bottom: 4px;">Ticket #${ticket.id}</div>
                <div style="font-size: 14px; color: var(--text-secondary);">${escapeHtml(ticket.subject || 'No subject')}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 12px; background: ${isOpen ? 'rgba(48, 209, 88, 0.15)' : 'rgba(142, 142, 147, 0.15)'};">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: ${isOpen ? 'var(--success)' : 'var(--text-secondary)'};"></div>
                <span style="font-size: 12px; font-weight: 600; color: ${isOpen ? 'var(--success)' : 'var(--text-secondary)'};">${ticket.status.toUpperCase()}</span>
              </div>
            </div>
            
            <div style="display: flex; gap: 16px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary);">
              <div>üë§ User: <code>${ticket.user_id}</code></div>
              <div>üìÖ ${ticket.created_at ? new Date(ticket.created_at).toLocaleDateString() : 'N/A'}</div>
            </div>
          </div>
          
          <!-- Conversation -->
          <div class="detail-card" style="margin-top: 12px;">
            <div style="font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 12px;">üí¨ Conversation</div>
            <div id="ticketConversation" style="max-height: 300px; overflow-y: auto; padding: 8px 0;">
              ${conversationHtml}
            </div>
          </div>
          
          ${isOpen ? `
            <!-- Reply Form -->
            <div class="detail-card" style="margin-top: 12px;">
              <div style="font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 12px;">‚úçÔ∏è Reply</div>
              <textarea id="ticketReplyText" class="form-textarea" placeholder="Type your reply..." style="min-height: 80px; margin-bottom: 12px;"></textarea>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="sendTicketReply(${ticket.id})">
                  üì§ Send Reply
                </button>
                <button class="btn btn-secondary" style="background: rgba(255, 59, 48, 0.15); color: var(--danger);" onclick="closeTicket(${ticket.id})">
                  ‚úï Close
                </button>
              </div>
            </div>
          ` : `
            <div style="text-align: center; margin-top: 16px; color: var(--text-secondary);">
              This ticket is closed.
            </div>
          `}
        `;
        
        // Scroll conversation to bottom
        setTimeout(() => {
          const conv = document.getElementById('ticketConversation');
          if (conv) conv.scrollTop = conv.scrollHeight;
        }, 100);
        
      } catch (error) {
        console.error('Failed to load ticket:', error);
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">‚ùå Error</div>
            <p style="color: var(--danger);">Failed to load ticket: ${error.message}</p>
            <button class="btn btn-secondary" onclick="loadTickets()" style="margin-top: 16px;">‚Üê Back to Tickets</button>
          </div>
        `;
      }
    }
    
    async function sendTicketReply(ticketId) {
      const textarea = document.getElementById('ticketReplyText');
      const message = textarea?.value?.trim();
      
      if (!message) {
        showError('Please enter a message');
        return;
      }
      
      try {
        const groupId = state.selectedGroup.group_id;
        await api(`/api/app/group/${groupId}/tickets/${ticketId}/reply`, { message });
        
        showSuccess('Reply sent!');
        textarea.value = '';
        
        // Reload ticket to show new message
        await loadTicketDetail(ticketId);
      } catch (error) {
        console.error('Failed to send reply:', error);
        showError('Failed to send reply: ' + error.message);
      }
    }
    
    async function closeTicket(ticketId) {
      if (!confirm('Are you sure you want to close this ticket?')) return;
      
      try {
        const groupId = state.selectedGroup.group_id;
        await api(`/api/app/group/${groupId}/tickets/${ticketId}/close`);
        
        showSuccess('Ticket closed');
        
        // Go back to tickets list
        loadTickets();
      } catch (error) {
        console.error('Failed to close ticket:', error);
        showError('Failed to close ticket: ' + error.message);
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===== ANALYTICS =====
    async function loadAnalytics() {
      if (!state.selectedGroup) return;
      showView('analytics');
      const view = document.getElementById('analyticsView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading analytics...</div>';
      
      try {
        const groupId = state.selectedGroup.group_id;
        const data = await api(`/api/app/group/${groupId}/analytics`);
        
        const memberCount = data.member_count || state.selectedGroup?.member_count || 0;
        const verifiedCount = data.verified_count || 0;
        const pendingCount = data.pending_count || 0;
        const warningCount = data.warning_count || 0;
        const ticketCount = data.ticket_count || 0;
        const adminActions = data.admin_actions_24h || 0;
        
        // Calculate verification rate
        const verificationRate = memberCount > 0 ? Math.round((verifiedCount / memberCount) * 100) : 0;
        
        view.innerHTML = `
          <div style="padding: 16px;">
            <!-- Overview Stats Grid -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
              <div style="background: linear-gradient(135deg, #0a84ff 0%, #0066cc 100%); border-radius: 16px; padding: 16px; text-align: center;">
                <div style="font-size: 32px; font-weight: 700; color: #fff;">${memberCount.toLocaleString()}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">Total Members</div>
              </div>
              <div style="background: linear-gradient(135deg, #30d158 0%, #28a745 100%); border-radius: 16px; padding: 16px; text-align: center;">
                <div style="font-size: 32px; font-weight: 700; color: #fff;">${verifiedCount.toLocaleString()}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">Verified</div>
              </div>
            </div>
            
            <!-- Verification Progress -->
            <div style="background: var(--bg-secondary); border-radius: 16px; padding: 16px; margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 14px; font-weight: 500;">Verification Rate</span>
                <span style="font-size: 14px; font-weight: 600; color: var(--success);">${verificationRate}%</span>
              </div>
              <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; width: ${verificationRate}%; background: linear-gradient(90deg, var(--success), #28a745); border-radius: 4px; transition: width 0.5s ease;"></div>
              </div>
            </div>
            
            <!-- Activity Stats -->
            <div style="background: var(--bg-secondary); border-radius: 16px; padding: 16px; margin-bottom: 20px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);">Activity</div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--separator);">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(255, 159, 10, 0.15); display: flex; align-items: center; justify-content: center; font-size: 18px;">‚è≥</div>
                  <div>
                    <div style="font-size: 14px; font-weight: 500;">Pending Verification</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Awaiting completion</div>
                  </div>
                </div>
                <div style="font-size: 18px; font-weight: 600; color: var(--warning);">${pendingCount}</div>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--separator);">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(255, 69, 58, 0.15); display: flex; align-items: center; justify-content: center; font-size: 18px;">‚ö†Ô∏è</div>
                  <div>
                    <div style="font-size: 14px; font-weight: 500;">Warnings Issued</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Total all time</div>
                  </div>
                </div>
                <div style="font-size: 18px; font-weight: 600; color: var(--danger);">${warningCount}</div>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(10, 132, 255, 0.15); display: flex; align-items: center; justify-content: center; font-size: 18px;">üé´</div>
                  <div>
                    <div style="font-size: 14px; font-weight: 500;">Active Tickets</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Open support requests</div>
                  </div>
                </div>
                <div style="font-size: 18px; font-weight: 600; color: var(--accent);">${ticketCount}</div>
              </div>
            </div>
            
            <!-- Admin Activity -->
            <div style="background: var(--bg-secondary); border-radius: 16px; padding: 16px;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);">Last 24 Hours</div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(48, 209, 88, 0.15); display: flex; align-items: center; justify-content: center; font-size: 18px;">‚ö°</div>
                  <div>
                    <div style="font-size: 14px; font-weight: 500;">Admin Actions</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Moderation activity</div>
                  </div>
                </div>
                <div style="font-size: 18px; font-weight: 600; color: var(--success);">${adminActions}</div>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load analytics:', error);
        const memberCount = state.selectedGroup?.member_count || 0;
        view.innerHTML = `
          <div style="padding: 16px;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
              <div style="background: linear-gradient(135deg, #0a84ff 0%, #0066cc 100%); border-radius: 16px; padding: 16px; text-align: center;">
                <div style="font-size: 32px; font-weight: 700; color: #fff;">${memberCount.toLocaleString()}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">Total Members</div>
              </div>
              <div style="background: var(--bg-secondary); border-radius: 16px; padding: 16px; text-align: center;">
                <div style="font-size: 32px; font-weight: 700; color: var(--text-secondary);">--</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Verified</div>
              </div>
            </div>
            
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
              <div style="font-size: 48px; margin-bottom: 12px;">üìä</div>
              <div style="font-size: 14px;">Unable to load detailed analytics</div>
              <button onclick="loadAnalytics()" class="btn btn-secondary" style="margin-top: 16px;">
                Retry
              </button>
            </div>
          </div>
        `;
      }
    }

    // ===== RULES =====
    async function loadRules() {
      if (!state.selectedGroup) return;
      showView('rules');
      const view = document.getElementById('rulesView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading rules...</div>';
      
      try {
        const groupId = state.selectedGroup.group_id;
        const data = await api(`/api/app/group/${groupId}/rules`);
        const rules = data.rules || [];
        
        if (rules.length === 0) {
          view.innerHTML = `
            <div class="detail-card">
              <div class="detail-title">üìã Auto-Moderation Rules</div>
              <p style="color: var(--text-secondary); margin-bottom: 16px;">Create and manage automated moderation rules.</p>
              
              <div style="margin-top: 20px; text-align: center; color: var(--text-secondary);">
                No rules configured
              </div>
              
              <button class="btn btn-primary" style="margin-top: 16px;" onclick="showAddRuleForm()">
                + Add Rule
              </button>
            </div>
          `;
          return;
        }
        
        const rulesHtml = rules.map(r => `
          <div class="card-row" style="border-bottom: 1px solid var(--separator); padding: 12px 0;">
            <div class="card-content" style="flex: 1;">
              <div class="card-title">${escapeHtml(r.name || 'Unnamed Rule')}</div>
              <div class="card-subtitle">${escapeHtml(r.match_type)}: "${escapeHtml(r.pattern)}" ‚Üí ${escapeHtml(r.action_type)}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
              <div class="toggle ${r.enabled ? 'on' : ''}" onclick="toggleRule(${r.id})" title="${r.enabled ? 'Enabled' : 'Disabled'}">
                <div class="toggle-knob"></div>
              </div>
              <button onclick="confirmDeleteRule(${r.id}, '${escapeHtml(r.name || 'this rule')}')" style="background: var(--bg-tertiary); border: none; color: var(--danger); font-size: 16px; cursor: pointer; padding: 8px 12px; border-radius: 8px;" title="Delete rule">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');
        
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üìã Auto-Moderation Rules (${rules.length})</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Create and manage automated moderation rules.</p>
            ${rulesHtml}
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="showAddRuleForm()">
              + Add Rule
            </button>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load rules:', error);
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üìã Auto-Moderation Rules</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Create and manage automated moderation rules.</p>
            
            <div style="margin-top: 20px; text-align: center; color: var(--text-secondary);">
              No rules configured
            </div>
            
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="showAddRuleForm()">
              + Add Rule
            </button>
          </div>
        `;
      }
    }

    async function toggleRule(ruleId) {
      // Toggle visual state
      const toggle = event.target.closest('.toggle');
      if (toggle) {
        toggle.classList.toggle('on');
        const enabled = toggle.classList.contains('on');
        
        try {
          const groupId = state.selectedGroup.group_id;
          await api(`/api/app/group/${groupId}/rules/${ruleId}/toggle`, { enabled });
        } catch (error) {
          // Revert toggle on error
          toggle.classList.toggle('on');
          showError('Failed to toggle rule: ' + error.message);
        }
      }
    }
    
    function confirmDeleteRule(ruleId, ruleName) {
      // Use Telegram's native confirmation dialog for better UX
      if (tg?.showConfirm) {
        tg.showConfirm(`Delete rule "${ruleName}"? This action cannot be undone.`, (confirmed) => {
          if (confirmed) {
            deleteRule(ruleId);
          }
        });
      } else {
        // Fallback for non-Telegram environments
        if (confirm(`Delete rule "${ruleName}"? This action cannot be undone.`)) {
          deleteRule(ruleId);
        }
      }
    }
    
    async function deleteRule(ruleId) {
      try {
        const groupId = state.selectedGroup.group_id;
        await api(`/api/app/group/${groupId}/rules/${ruleId}/delete`, {});
        showSuccess('Rule deleted');
        loadRules(); // Reload rules list
      } catch (error) {
        console.error('Failed to delete rule:', error);
        showError('Failed to delete rule: ' + error.message);
      }
    }

    function showAddRuleForm() {
      const view = document.getElementById('rulesView');
      view.innerHTML = `
        <div class="detail-card">
          <div class="detail-title">üìã Add New Rule</div>
          
          <div class="form-group">
            <label class="form-label">Rule Name</label>
            <input type="text" class="form-input" id="ruleName" placeholder="e.g., Block spam links" />
          </div>
          
          <div class="form-group">
            <label class="form-label">Match Type</label>
            <select class="form-input" id="ruleMatchType">
              <option value="contains">Contains</option>
              <option value="exact">Exact Match</option>
              <option value="regex">Regex</option>
              <option value="starts_with">Starts With</option>
              <option value="ends_with">Ends With</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Pattern</label>
            <input type="text" class="form-input" id="rulePattern" placeholder="Text to match..." />
          </div>
          
          <div class="form-group">
            <label class="form-label">Action</label>
            <select class="form-input" id="ruleAction">
              <option value="delete">Delete Message</option>
              <option value="warn">Warn User</option>
              <option value="mute">Mute User</option>
              <option value="kick">Kick User</option>
              <option value="ban">Ban User</option>
            </select>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" style="flex: 1;" onclick="loadRules()">Cancel</button>
            <button class="btn btn-primary" style="flex: 1;" onclick="saveRule()">Save Rule</button>
          </div>
        </div>
      `;
    }

    async function saveRule() {
      if (!state.selectedGroup) return;
      
      try {
        const groupId = state.selectedGroup.group_id;
        const name = document.getElementById('ruleName').value.trim();
        const matchType = document.getElementById('ruleMatchType').value;
        const pattern = document.getElementById('rulePattern').value.trim();
        const actionType = document.getElementById('ruleAction').value;
        
        if (!name || !pattern) {
          showError('Please fill in all required fields');
          return;
        }
        
        // Use the correct endpoint for creating rules
        await api(`/api/app/group/${groupId}/rules/create`, {
          name,
          match_type: matchType,
          pattern,
          action_type: actionType,
          enabled: true,
          trigger: 'message_group'
        });
        
        showSuccess('Rule created successfully');
        loadRules(); // Reload rules list
      } catch (error) {
        console.error('Failed to save rule:', error);
        showError('Failed to save rule: ' + error.message);
      }
    }

    // ===== ONBOARDING =====
    async function loadOnboarding() {
      showView('onboarding');
      const view = document.getElementById('onboardingView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';
      
      try {
        const onboarding = state.selectedGroup?.onboarding || {};
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üëã Welcome Flow</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Configure welcome messages for new members.</p>
            
            <div class="toggle-row">
              <span>Enable Welcome Message</span>
              <div class="toggle ${onboarding.enabled ? 'on' : ''}" onclick="toggleOnboarding()">
                <div class="toggle-knob"></div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Welcome Message</label>
              <textarea class="form-textarea" id="onboardingText" placeholder="Enter welcome message...">${onboarding.text || ''}</textarea>
            </div>
            
            <div class="form-group">
              <label class="form-label">Delay (seconds)</label>
              <input type="number" class="form-input" id="onboardingDelay" value="${onboarding.delay_seconds || 0}" />
            </div>
            
            <button class="btn btn-primary" onclick="saveOnboarding()">Save Changes</button>
          </div>
        `;
      } catch (error) {
        view.innerHTML = `<div style="padding: 20px; color: var(--danger);">Error: ${error.message}</div>`;
      }
    }

    function toggleOnboarding() {
      const toggle = event.target.closest('.toggle');
      if (toggle) {
        toggle.classList.toggle('on');
      }
    }

    async function saveOnboarding() {
      if (!state.selectedGroup) return;
      
      try {
        const groupId = state.selectedGroup.group_id;
        
        // Get toggle state
        const toggle = document.querySelector('#onboardingView .toggle');
        const enabled = toggle?.classList.contains('on') ?? false;
        
        const text = document.getElementById('onboardingText').value.trim();
        const delaySeconds = parseInt(document.getElementById('onboardingDelay').value) || 0;
        
        // Call API to save onboarding settings
        await api(`/api/app/group/${groupId}/onboarding`, {
          enabled: enabled,
          text: text,
          delay_seconds: delaySeconds,
          parse_mode: 'HTML'
        });
        
        // Update local state
        state.selectedGroup.onboarding = {
          enabled: enabled,
          text: text,
          delay_seconds: delaySeconds,
          parse_mode: 'HTML'
        };
        
        showSuccess('Onboarding settings saved');
      } catch (error) {
        console.error('Failed to save onboarding:', error);
        showError('Failed to save: ' + error.message);
      }
    }

    // ===== BROADCAST =====
    async function loadBroadcast() {
      if (!state.selectedGroup) return;
      showView('broadcast');
      const view = document.getElementById('broadcastView');
      view.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';
      
      try {
        // Load recent broadcasts
        const groupId = state.selectedGroup.group_id;
        let broadcasts = [];
        try {
          const data = await api(`/api/app/group/${groupId}/broadcasts`);
          broadcasts = data.broadcasts || [];
        } catch (e) {
          console.warn('Failed to load broadcasts:', e);
        }
        
        const recentHtml = broadcasts.length > 0 ? broadcasts.slice(0, 5).map(b => `
          <div style="padding: 10px 0; border-bottom: 1px solid var(--separator);">
            <div style="font-size: 13px; color: var(--text-secondary);">${new Date(b.created_at).toLocaleString()}</div>
            <div style="font-size: 14px; color: var(--text); margin-top: 4px;">${(b.text || '').substring(0, 100)}${(b.text || '').length > 100 ? '...' : ''}</div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
              Status: ${b.status} | Sent: ${b.sent_count || 0}/${b.total_targets || 0}
            </div>
          </div>
        `).join('') : '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No recent broadcasts</div>';
        
        view.innerHTML = `
          <div class="detail-card">
            <div class="detail-title">üì¢ Send Broadcast</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Send an announcement to all group members.</p>
            
            <div class="form-group">
              <label class="form-label">Message</label>
              <textarea class="form-textarea" id="broadcastText" placeholder="Enter your announcement..." style="min-height: 120px;"></textarea>
              <small style="color: var(--text-secondary);">Supports HTML formatting: &lt;b&gt;bold&lt;/b&gt;, &lt;i&gt;italic&lt;/i&gt;, &lt;a href="..."&gt;link&lt;/a&gt;</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Send Timing</label>
              <select class="form-input" id="broadcastDelay">
                <option value="0">Send immediately</option>
                <option value="300">In 5 minutes</option>
                <option value="900">In 15 minutes</option>
                <option value="1800">In 30 minutes</option>
                <option value="3600">In 1 hour</option>
              </select>
            </div>
            
            <button class="btn btn-primary" style="width: 100%;" onclick="sendBroadcast()">üì§ Send Broadcast</button>
          </div>
          
          <div class="detail-card" style="margin-top: 16px;">
            <div class="detail-title">üìú Recent Broadcasts</div>
            ${recentHtml}
          </div>
        `;
      } catch (error) {
        view.innerHTML = `<div style="padding: 20px; color: var(--danger);">Error: ${error.message}</div>`;
      }
    }
    
    async function sendBroadcast() {
      if (!state.selectedGroup) return;
      
      const text = document.getElementById('broadcastText')?.value?.trim();
      if (!text) {
        showError('Please enter a message');
        return;
      }
      
      const delaySeconds = parseInt(document.getElementById('broadcastDelay')?.value) || 0;
      
      if (!confirm(`Send this broadcast to ${state.selectedGroup.group_name}?`)) {
        return;
      }
      
      try {
        const groupId = state.selectedGroup.group_id;
        await api(`/api/app/group/${groupId}/broadcast`, {
          text: text,
          delay_seconds: delaySeconds,
          parse_mode: 'HTML'
        });
        
        showSuccess(delaySeconds > 0 ? 'Broadcast scheduled!' : 'Broadcast sent!');
        document.getElementById('broadcastText').value = '';
        
        // Reload to show in recent broadcasts
        setTimeout(() => loadBroadcast(), 1000);
      } catch (error) {
        console.error('Failed to send broadcast:', error);
        showError('Failed to send: ' + error.message);
      }
    }

    // ===== INIT =====
    if (tg) {
      tg.ready();
      tg.expand();
      tg.enableClosingConfirmation();
    }

    // Load bot info and status
    (async () => {
      try {
        // Get bot info
        try {
          const botResponse = await fetch('/');
          const botData = await botResponse.json();
          state.botInfo = { username: 'mercleMerci_bot' }; // Default
        } catch (e) {
          console.warn('Failed to fetch bot info, using defaults:', e);
          state.botInfo = { username: 'mercleMerci_bot' };
        }
        
        // Hide global header on initial load (status page)
        const globalHeader = document.getElementById('globalHeader');
        if (globalHeader) globalHeader.classList.add('hidden');
        
        // Load user status
        await loadStatus();
      } catch (error) {
        console.error('Initialization error:', error);
        const content = document.getElementById('statusContent');
        if (content) {
          content.innerHTML = `
            <div class="card">
              <div class="card-section">
                <div class="card-row">
                  <div class="card-icon icon-danger">‚ùå</div>
                  <div class="card-content">
                    <div class="card-title">Initialization Failed</div>
                    <div class="card-subtitle">${error.message || 'Unknown error'}</div>
                  </div>
                </div>
                <p style="color: var(--text-secondary); font-size: 13px; margin-top: 12px;">
                  Please try reopening the Mini App from Telegram.
                </p>
              </div>
            </div>
            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 16px;">
              üîÑ Reload App
            </button>
          `;
        }
      }
    })();
  </script>
</body>
</html>
